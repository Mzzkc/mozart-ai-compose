# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║                    PHASE D4: MODULARIZE cli.py                               ║
# ║                                                                              ║
# ║  Split src/mozart/cli.py (6180 LOC) into command modules                     ║
# ║  Final job in D1→D2→D3→D4 chain                                              ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: "modularization-d4-cli"
description: "Split cli.py into command modules with backward compatibility"

workspace: "/home/emzi/Projects/mozart-ai-compose/modularization-workspace-d4"

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: "/home/emzi/Projects/mozart-ai-compose"
  timeout_seconds: 7200

cross_sheet:
  auto_capture_stdout: true
  max_output_chars: 2000
  lookback_sheets: 1

sheet:
  size: 1
  total_items: 12
  start_item: 1

retry:
  max_retries: 2

prompt:
  template: |
    {{ preamble }}

    {% if sheet_num == 1 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 1: ANALYZE cli.py STRUCTURE                                           ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Task:** Analyze CLI structure and plan command modules

    1. Read `src/mozart/cli.py`
    2. List all @app.command() functions
    3. Group commands by functionality:
       - Core: run, resume, status, list_jobs
       - Control: pause, modify
       - Recovery: recover
       - Validation: validate
       - Diagnostics: logs, errors, diagnose
       - Dashboard: dashboard, mcp
       - Learning: patterns-*, learning-*, entropy-*
    4. Count LOC per group
    5. Identify shared helpers

    Write analysis to {{ workspace }}/sheet1-analysis.md

    {% elif sheet_num == 2 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 2: CREATE helpers.py - Shared Utilities                               ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[1][:500] if 1 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract shared utilities

    Create `src/mozart/cli_staging/__init__.py` (empty, for package).
    Create `src/mozart/cli_staging/helpers.py`:
    - Logger setup
    - Backend creation helpers
    - Config loading utilities
    - Console/Rich setup
    - Common decorators

    **Verify:** `python -c "from mozart.cli_staging.helpers import *; print('OK')"`

    Write progress to {{ workspace }}/sheet2-helpers.md

    {% elif sheet_num == 3 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 3: CREATE output.py - Rich Formatting                                 ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[2][:500] if 2 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract Rich formatting code

    Create `src/mozart/cli_staging/output.py`:
    - OutputLevel enum
    - Table builders
    - Progress bars
    - Status formatting
    - Color schemes

    **Verify:** `python -c "from mozart.cli_staging.output import *; print('OK')"`

    Write progress to {{ workspace }}/sheet3-output.md

    {% elif sheet_num == 4 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 4: CREATE commands/run.py                                             ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[3][:500] if 3 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract run command

    Create `src/mozart/cli_staging/commands/__init__.py` (empty, for package).
    Create `src/mozart/cli_staging/commands/run.py`:
    - `run()` command function
    - All parameters and options
    - Job execution logic

    **Verify:** `python -c "from mozart.cli_staging.commands.run import run; print('OK')"`

    Write progress to {{ workspace }}/sheet4-run.md

    {% elif sheet_num == 5 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 5: CREATE commands/status.py                                          ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[4][:500] if 4 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract status commands

    Create `src/mozart/cli_staging/commands/status.py`:
    - `status()` command
    - `list_jobs()` command
    - Status formatting helpers

    **Verify:** `python -c "from mozart.cli_staging.commands.status import status, list_jobs; print('OK')"`

    Write progress to {{ workspace }}/sheet5-status.md

    {% elif sheet_num == 6 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 6: CREATE commands/resume.py + pause.py                               ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[5][:500] if 5 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract resume and pause commands

    Create `src/mozart/cli_staging/commands/resume.py`:
    - `resume()` command

    Create `src/mozart/cli_staging/commands/pause.py`:
    - `pause()` command
    - `modify()` command

    **Verify:**
    ```bash
    python -c "from mozart.cli_staging.commands.resume import resume; print('OK')"
    python -c "from mozart.cli_staging.commands.pause import pause, modify; print('OK')"
    ```

    Write progress to {{ workspace }}/sheet6-resume-pause.md

    {% elif sheet_num == 7 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 7: CREATE commands/validate.py + recover.py                           ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[6][:500] if 6 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract validation and recovery commands

    Create `src/mozart/cli_staging/commands/validate.py`:
    - `validate()` command

    Create `src/mozart/cli_staging/commands/recover.py`:
    - `recover()` command (hidden)

    **Verify:**
    ```bash
    python -c "from mozart.cli_staging.commands.validate import validate; print('OK')"
    python -c "from mozart.cli_staging.commands.recover import recover; print('OK')"
    ```

    Write progress to {{ workspace }}/sheet7-validate-recover.md

    {% elif sheet_num == 8 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 8: CREATE commands/diagnose.py                                        ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[7][:500] if 7 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract diagnostic commands

    Create `src/mozart/cli_staging/commands/diagnose.py`:
    - `logs()` command
    - `errors()` command
    - `diagnose()` command

    **Verify:** `python -c "from mozart.cli_staging.commands.diagnose import logs, errors, diagnose; print('OK')"`

    Write progress to {{ workspace }}/sheet8-diagnose.md

    {% elif sheet_num == 9 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 9: CREATE commands/dashboard.py                                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[8][:500] if 8 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract dashboard commands

    Create `src/mozart/cli_staging/commands/dashboard.py`:
    - `dashboard()` command
    - `mcp()` command

    **Verify:** `python -c "from mozart.cli_staging.commands.dashboard import dashboard; print('OK')"`

    Write progress to {{ workspace }}/sheet9-dashboard.md

    {% elif sheet_num == 10 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 10: CREATE commands/learning.py                                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[9][:500] if 9 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract learning/pattern commands (largest group)

    Create `src/mozart/cli_staging/commands/learning.py`:
    - All `patterns-*` commands
    - All `learning-*` commands
    - `entropy-status` command
    - Pattern display helpers

    **Verify:** `python -c "from mozart.cli_staging.commands.learning import *; print('OK')"`

    Write progress to {{ workspace }}/sheet10-learning.md

    {% elif sheet_num == 11 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 11: CREATE __init__.py IN STAGING                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[10][:500] if 10 in previous_outputs else "" }}
    {% endif %}

    **Task:** Create CLI package with assembled app in STAGING directory

    Create `src/mozart/cli_staging/__init__.py`:
    ```python
    """Mozart CLI - modular command structure."""
    import typer
    from mozart.cli_staging.commands import (
        run, status, resume, pause,
        validate, recover, diagnose,
        dashboard, learning
    )

    app = typer.Typer(...)

    # Register all commands
    app.command()(run.run)
    app.command()(status.status)
    # ... etc

    # Or use add_typer for command groups
    ```

    **IMPORTANT:** Create in `cli_staging/`, NOT `cli/`. The atomic swap happens in Sheet 12.

    **Verify the assembled app loads:**
    ```bash
    python -c "from mozart.cli_staging import app; print(f'Commands: {len(app.registered_commands)}')"
    ```

    Write progress to {{ workspace }}/sheet11-init.md

    {% elif sheet_num == 12 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 12: ATOMIC SWAP + FINAL VERIFICATION                                  ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[11][:500] if 11 in previous_outputs else "" }}
    {% endif %}

    **Task:** Perform atomic swap and COMPREHENSIVE verification

    **CRITICAL: This sheet performs the atomic swap from staging to final.**

    **Step 1: Atomic Swap**
    ```bash
    # 1. Atomic swap: staging → final
    mv src/mozart/cli_staging src/mozart/cli

    # 2. Rename original file to legacy
    mv src/mozart/cli.py src/mozart/cli_legacy.py
    ```

    **Step 2: Update imports** from `cli_staging` to `cli`:
    - Change `from mozart.cli_staging.X` → `from mozart.cli.X`

    **Step 3: Create re-export shim** at `src/mozart/cli.py`:
    ```python
    """Mozart CLI - re-exports from modular package."""
    from mozart.cli import app, main
    __all__ = ["app", "main"]
    ```

    **Step 4: MANDATORY Quality Verification**

    Run these checks and FIX any failures before completing:

    ```bash
    # 4a. Verify all commands load (must pass)
    mozart --help
    mozart run --help
    mozart resume --help
    mozart status --help
    mozart pause --help
    mozart validate --help

    # 4b. Type check the new modules (fix any errors)
    mypy src/mozart/cli/ --ignore-missing-imports 2>&1 | head -20

    # 4c. Run CLI tests (must pass)
    pytest tests/test_cli*.py -x -q --tb=short 2>&1 | tail -30

    # 4d. Verify a real command works
    mozart validate examples/sheet-review.yaml --json
    ```

    **If any check fails:** Debug and fix the issue. Do NOT proceed with a broken CLI.

    **FINAL SUMMARY:**
    Write complete Phase D summary to {{ workspace }}/sheet12-final.md:
    - Total LOC modularized across D1-D4
    - Files created
    - Test results (include actual pytest output)
    - Type check results
    - Any issues encountered and how they were resolved

    {% endif %}

  variables:
    preamble: |
      ╔══════════════════════════════════════════════════════════════════════════╗
      ║                MOZART MODULARIZATION D4: cli.py → cli/                   ║
      ║                                                                          ║
      ║  Target: Split 6180 LOC file into command modules                        ║
      ║  Final job in the D1→D2→D3→D4 orchestra                                  ║
      ╚══════════════════════════════════════════════════════════════════════════╝

      **Module Structure:**
      ```
      src/mozart/cli_staging/
      ├── __init__.py           # Typer app assembly (~150 LOC)
      ├── helpers.py            # Shared utilities (~300 LOC)
      ├── output.py             # Rich formatting (~400 LOC)
      └── commands/
          ├── __init__.py
          ├── run.py            # run command (~500 LOC)
          ├── status.py         # status, list_jobs (~600 LOC)
          ├── resume.py         # resume (~500 LOC)
          ├── pause.py          # pause, modify (~500 LOC)
          ├── validate.py       # validate (~150 LOC)
          ├── recover.py        # recover (~200 LOC)
          ├── diagnose.py       # logs, errors, diagnose (~500 LOC)
          ├── dashboard.py      # dashboard, mcp (~150 LOC)
          └── learning.py       # patterns-*, learning-* (~1200 LOC)
      ```

validations:
  # Sheet 2: helpers.py created (exclude sheet 12 - after atomic swap)
  - type: file_exists
    path: "src/mozart/cli_staging/helpers.py"
    description: "helpers.py module must exist"
    condition: "sheet_num >= 2 and sheet_num < 12"

  # Sheet 3: output.py created
  - type: file_exists
    path: "src/mozart/cli_staging/output.py"
    description: "output.py module must exist"
    condition: "sheet_num >= 3 and sheet_num < 12"

  # Sheet 4: commands/run.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/run.py"
    description: "commands/run.py must exist"
    condition: "sheet_num >= 4 and sheet_num < 12"

  # Sheet 5: commands/status.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/status.py"
    description: "commands/status.py must exist"
    condition: "sheet_num >= 5 and sheet_num < 12"

  # Sheet 6: commands/resume.py + pause.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/resume.py"
    description: "commands/resume.py must exist"
    condition: "sheet_num >= 6 and sheet_num < 12"

  - type: file_exists
    path: "src/mozart/cli_staging/commands/pause.py"
    description: "commands/pause.py must exist"
    condition: "sheet_num >= 6 and sheet_num < 12"

  # Sheet 7: commands/validate.py + recover.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/validate.py"
    description: "commands/validate.py must exist"
    condition: "sheet_num >= 7 and sheet_num < 12"

  # Sheet 8: commands/diagnose.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/diagnose.py"
    description: "commands/diagnose.py must exist"
    condition: "sheet_num >= 8 and sheet_num < 12"

  # Sheet 9: commands/dashboard.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/dashboard.py"
    description: "commands/dashboard.py must exist"
    condition: "sheet_num >= 9 and sheet_num < 12"

  # Sheet 10: commands/learning.py created
  - type: file_exists
    path: "src/mozart/cli_staging/commands/learning.py"
    description: "commands/learning.py must exist"
    condition: "sheet_num >= 10 and sheet_num < 12"

  # Sheet 11: __init__.py created in staging
  - type: file_exists
    path: "src/mozart/cli_staging/__init__.py"
    description: "Package __init__.py must exist in staging"
    condition: "sheet_num == 11"

  # Sheet 12: After atomic swap, check final location
  - type: file_exists
    path: "src/mozart/cli/__init__.py"
    description: "Package __init__.py must exist after swap"
    condition: "sheet_num == 12"

  # Sheet 12: CLI loads
  - type: command_succeeds
    command: "mozart --help"
    description: "Mozart CLI must load"
    condition: "sheet_num == 12"

  # Sheet 12: Core commands work
  - type: command_succeeds
    command: "mozart run --help"
    description: "mozart run command must work"
    condition: "sheet_num == 12"

  - type: command_succeeds
    command: "mozart resume --help"
    description: "mozart resume command must work"
    condition: "sheet_num == 12"

  - type: command_succeeds
    command: "mozart status --help"
    description: "mozart status command must work"
    condition: "sheet_num == 12"

  - type: command_succeeds
    command: "mozart pause --help"
    description: "mozart pause command must work"
    condition: "sheet_num == 12"

  # Sheet 12: Diagnostic commands work
  - type: command_succeeds
    command: "mozart diagnose --help"
    description: "mozart diagnose command must work"
    condition: "sheet_num == 12"

  # Sheet 12: Learning commands work
  - type: command_succeeds
    command: "mozart patterns-list --help"
    description: "mozart patterns-list command must work"
    condition: "sheet_num == 12"

  # Sheet 12: Validate command actually works (not just --help)
  - type: command_succeeds
    command: "mozart validate examples/sheet-review.yaml --json 2>&1 | grep -E '(valid|Valid)'"
    description: "Mozart validate command must work on real file"
    condition: "sheet_num == 12"

  # Sheet 12: CLI tests pass (critical quality gate)
  - type: command_succeeds
    command: "pytest tests/test_cli.py tests/test_cli_pause.py -x -q --tb=no 2>&1 | tail -1 | grep -E 'passed'"
    description: "CLI tests must pass"
    condition: "sheet_num == 12"

# No on_success - this is the final job in the chain
# Optionally chain to Phase E (simplification) if desired:
# on_success:
#   - type: run_job
#     job_path: "simplification-e.yaml"
#     description: "Chain to Phase E: Code Simplification"

concert:
  enabled: true
  max_chain_depth: 10
  cooldown_between_jobs_seconds: 30
  inherit_workspace: false
