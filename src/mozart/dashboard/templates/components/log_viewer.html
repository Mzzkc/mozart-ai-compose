<!-- Log Viewer Component -->
<!-- This component displays job execution logs with filtering, search, and real-time updates -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <!-- Log Viewer Header -->
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                Execution Logs
            </h3>
            <div class="flex items-center space-x-3">
                <!-- Log Level Filter -->
                <div x-data="{ selected: 'all' }" class="relative">
                    <select x-model="selected"
                            @change="filterLogs($event.target.value)"
                            class="block w-full pl-3 pr-10 py-2 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">All Levels</option>
                        <option value="debug">Debug</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                    </select>
                </div>

                <!-- Auto-scroll Toggle -->
                <label class="flex items-center">
                    <input type="checkbox"
                           x-model="autoScroll"
                           class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Auto-scroll</span>
                </label>

                <!-- Clear Logs Button -->
                <button @click="clearLogs()"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear
                </button>

                <!-- Download Logs Button -->
                <button @click="downloadLogs()"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4m-6 4h8a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    Download
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-4">
            <div class="relative">
                <input x-model="searchQuery"
                       @input="filterLogs()"
                       type="text"
                       placeholder="Search logs..."
                       class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Log Container -->
        <div class="relative">
            <!-- Log Lines Container -->
            <div id="log-container"
                 class="bg-gray-900 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                <div class="h-96 overflow-y-auto font-mono text-sm"
                     x-data="logViewer"
                     x-init="init()">

                    <!-- Empty State -->
                    <div x-show="filteredLogs.length === 0"
                         class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No logs available</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Logs will appear here as the job executes.</p>
                        </div>
                    </div>

                    <!-- Log Lines -->
                    <template x-for="(log, index) in filteredLogs" :key="log.id || index">
                        <div class="flex border-b border-gray-700 dark:border-gray-800 hover:bg-gray-800 dark:hover:bg-gray-900 transition-colors group">
                            <!-- Line Number -->
                            <div class="flex-shrink-0 w-16 px-3 py-2 text-right text-xs text-gray-500 dark:text-gray-400 bg-gray-800 dark:bg-gray-900 border-r border-gray-700 dark:border-gray-800">
                                <span x-text="index + 1"></span>
                            </div>

                            <!-- Timestamp -->
                            <div class="flex-shrink-0 w-32 px-3 py-2 text-xs text-gray-400">
                                <span x-text="formatTimestamp(log.timestamp)"></span>
                            </div>

                            <!-- Level Badge -->
                            <div class="flex-shrink-0 w-20 px-2 py-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                                      :class="{
                                          'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200': log.level === 'debug',
                                          'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': log.level === 'info',
                                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200': log.level === 'warning',
                                          'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': log.level === 'error'
                                      }"
                                      x-text="log.level.toUpperCase()"></span>
                            </div>

                            <!-- Message -->
                            <div class="flex-1 px-3 py-2 text-sm"
                                 :class="{
                                     'text-gray-300': log.level === 'debug',
                                     'text-white': log.level === 'info',
                                     'text-yellow-200': log.level === 'warning',
                                     'text-red-200': log.level === 'error'
                                 }">
                                <pre class="whitespace-pre-wrap break-words" x-text="log.message"></pre>
                            </div>

                            <!-- Copy Button -->
                            <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity px-2 py-2">
                                <button @click="copyLogLine(log)"
                                        class="text-gray-400 hover:text-gray-300 p-1">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Scroll to Bottom Button -->
                <button x-show="!isAtBottom && logs.length > 0"
                        @click="scrollToBottom()"
                        class="absolute bottom-4 right-4 inline-flex items-center p-2 border border-transparent rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                    </svg>
                </button>
            </div>

            <!-- Log Stats -->
            <div class="mt-3 flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                <div>
                    Showing <span x-text="filteredLogs.length"></span> of <span x-text="logs.length"></span> log entries
                </div>
                <div class="flex items-center space-x-4">
                    <span class="flex items-center">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mr-1"></div>
                        Info: <span x-text="logStats.info" class="ml-1 font-medium"></span>
                    </span>
                    <span class="flex items-center">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full mr-1"></div>
                        Warnings: <span x-text="logStats.warning" class="ml-1 font-medium"></span>
                    </span>
                    <span class="flex items-center">
                        <div class="w-2 h-2 bg-red-500 rounded-full mr-1"></div>
                        Errors: <span x-text="logStats.error" class="ml-1 font-medium"></span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Log Viewer Alpine.js Component
document.addEventListener('alpine:init', () => {
    Alpine.data('logViewer', () => ({
        logs: [],
        filteredLogs: [],
        searchQuery: '',
        levelFilter: 'all',
        autoScroll: true,
        isAtBottom: true,
        logStats: {
            debug: 0,
            info: 0,
            warning: 0,
            error: 0
        },

        init() {
            // Initialize with sample data or load from API
            this.loadLogs();

            // Watch for scroll position
            this.$nextTick(() => {
                const container = this.$el.querySelector('.overflow-y-auto');
                container.addEventListener('scroll', () => {
                    this.checkIfAtBottom(container);
                });
            });

            // Auto-refresh logs every 5 seconds
            setInterval(() => {
                if (this.autoScroll) {
                    this.loadLogs();
                }
            }, 5000);
        },

        loadLogs() {
            // In production, this would fetch from /api/jobs/{job_id}/logs
            // For now, we'll simulate log entries
            const sampleLogs = [
                { id: 1, timestamp: new Date().toISOString(), level: 'info', message: 'Job started successfully' },
                { id: 2, timestamp: new Date(Date.now() - 5000).toISOString(), level: 'debug', message: 'Loading configuration...' },
                { id: 3, timestamp: new Date(Date.now() - 10000).toISOString(), level: 'info', message: 'Executing sheet 1...' },
                { id: 4, timestamp: new Date(Date.now() - 15000).toISOString(), level: 'warning', message: 'Rate limit encountered, waiting 30s...' },
                { id: 5, timestamp: new Date(Date.now() - 20000).toISOString(), level: 'error', message: 'API request failed: timeout' }
            ];

            this.logs = sampleLogs;
            this.updateLogStats();
            this.filterLogs();

            if (this.autoScroll) {
                this.$nextTick(() => this.scrollToBottom());
            }
        },

        updateLogStats() {
            this.logStats = {
                debug: this.logs.filter(log => log.level === 'debug').length,
                info: this.logs.filter(log => log.level === 'info').length,
                warning: this.logs.filter(log => log.level === 'warning').length,
                error: this.logs.filter(log => log.level === 'error').length
            };
        },

        filterLogs(level = this.levelFilter) {
            this.levelFilter = level;
            let filtered = this.logs;

            // Filter by level
            if (this.levelFilter !== 'all') {
                filtered = filtered.filter(log => log.level === this.levelFilter);
            }

            // Filter by search query
            if (this.searchQuery.trim()) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(log =>
                    log.message.toLowerCase().includes(query) ||
                    log.level.toLowerCase().includes(query)
                );
            }

            this.filteredLogs = filtered;
        },

        formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$el.querySelector('.overflow-y-auto');
                container.scrollTop = container.scrollHeight;
            });
        },

        checkIfAtBottom(container) {
            const threshold = 50; // pixels from bottom
            this.isAtBottom = (container.scrollHeight - container.scrollTop - container.clientHeight) < threshold;
        },

        copyLogLine(log) {
            const text = `[${this.formatTimestamp(log.timestamp)}] ${log.level.toUpperCase()}: ${log.message}`;
            navigator.clipboard.writeText(text).then(() => {
                // Show notification
                if (window.app && window.app.addNotification) {
                    window.app.addNotification({
                        type: 'success',
                        title: 'Copied',
                        message: 'Log line copied to clipboard'
                    });
                }
            });
        },

        clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                this.logs = [];
                this.filteredLogs = [];
                this.updateLogStats();
            }
        },

        downloadLogs() {
            const logText = this.logs.map(log =>
                `[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}`
            ).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `job-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }));
});
</script>