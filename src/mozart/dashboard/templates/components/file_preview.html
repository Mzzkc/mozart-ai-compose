<!-- File Preview Modal Component -->
<!-- This component renders file content previews with syntax highlighting and various file type support -->

<div x-data="filePreview" class="file-preview-container">
    <!-- Preview Header -->
    <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <!-- File Type Icon -->
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                         :class="getFileTypeColor(file.name)">
                        <svg class="w-5 h-5" :class="getFileIconColor(file.name)" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- File Info -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white" x-text="file.name"></h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        <span x-text="formatFileSize(file.size)"></span>
                        • Modified <span x-text="formatDateTime(file.modified)"></span>
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center space-x-2">
                <!-- Line Numbers Toggle -->
                <button x-show="isTextFile(file.name)"
                        @click="showLineNumbers = !showLineNumbers"
                        :class="showLineNumbers ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9l3 3-3 3m8-6l3 3-3 3"/>
                    </svg>
                    Lines
                </button>

                <!-- Word Wrap Toggle -->
                <button x-show="isTextFile(file.name)"
                        @click="wordWrap = !wordWrap"
                        :class="wordWrap ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"/>
                    </svg>
                    Wrap
                </button>

                <!-- Copy Button -->
                <button x-show="isTextFile(file.name)"
                        @click="copyContent()"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    Copy
                </button>

                <!-- Download Button -->
                <button @click="downloadFile()"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4"/>
                    </svg>
                    Download
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Content -->
    <div class="preview-content">
        <!-- Loading State -->
        <div x-show="loading" class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <span class="ml-3 text-gray-600 dark:text-gray-400">Loading file content...</span>
        </div>

        <!-- Error State -->
        <div x-show="error && !loading" class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">Preview Failed</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" x-text="errorMessage"></p>
            <div class="mt-6">
                <button @click="retryLoad()"
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Try Again
                </button>
            </div>
        </div>

        <!-- Text File Preview -->
        <div x-show="!loading && !error && isTextFile(file.name)" class="text-file-preview">
            <div class="bg-gray-900 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                <div class="max-h-96 overflow-auto"
                     :class="wordWrap ? 'whitespace-pre-wrap' : 'whitespace-pre'">
                    <table x-show="showLineNumbers" class="w-full text-sm font-mono">
                        <template x-for="(line, index) in contentLines" :key="index">
                            <tr class="hover:bg-gray-800 dark:hover:bg-gray-900 transition-colors">
                                <!-- Line Number -->
                                <td class="w-12 px-3 py-1 text-right text-xs text-gray-500 bg-gray-800 dark:bg-gray-900 border-r border-gray-700 dark:border-gray-800 select-none">
                                    <span x-text="index + 1"></span>
                                </td>
                                <!-- Line Content -->
                                <td class="px-3 py-1 text-gray-300 dark:text-gray-200">
                                    <pre class="inline" :class="getLanguageClass(file.name)" x-text="line || ' '"></pre>
                                </td>
                            </tr>
                        </template>
                    </table>

                    <pre x-show="!showLineNumbers"
                         class="p-4 text-sm text-gray-300 dark:text-gray-200"
                         :class="getLanguageClass(file.name)"
                         x-text="content"></pre>
                </div>
            </div>
        </div>

        <!-- JSON Preview -->
        <div x-show="!loading && !error && getFileType(file.name) === 'json'" class="json-preview">
            <div class="bg-gray-900 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                <pre class="text-sm text-gray-300 font-mono max-h-96 overflow-auto"
                     x-text="formatJson(content)"></pre>
            </div>
        </div>

        <!-- Markdown Preview -->
        <div x-show="!loading && !error && getFileType(file.name) === 'markdown'" class="markdown-preview">
            <div class="prose prose-sm dark:prose-invert max-w-none bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-h-96 overflow-auto">
                <div x-html="renderMarkdown(content)"></div>
            </div>
        </div>

        <!-- Image Preview -->
        <div x-show="!loading && !error && isImageFile(file.name)" class="image-preview text-center">
            <img :src="getFileUrl(file.path)"
                 :alt="file.name"
                 class="max-w-full max-h-96 mx-auto rounded-lg border border-gray-200 dark:border-gray-700"
                 @load="imageLoaded = true"
                 @error="handleImageError">
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                <span x-text="file.name"></span> • <span x-text="formatFileSize(file.size)"></span>
            </p>
        </div>

        <!-- Binary/Unsupported File -->
        <div x-show="!loading && !error && !isPreviewable(file.name)" class="binary-file text-center py-12">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Preview Not Available</h3>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                This file type cannot be previewed in the browser.
            </p>
            <div class="mt-6">
                <button @click="downloadFile()"
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4"/>
                    </svg>
                    Download File
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// File Preview Alpine.js Component
document.addEventListener('alpine:init', () => {
    Alpine.data('filePreview', () => ({
        file: {},
        content: '',
        contentLines: [],
        loading: true,
        error: false,
        errorMessage: '',
        showLineNumbers: true,
        wordWrap: false,
        imageLoaded: false,

        init() {
            // This would be called with file data from the parent
            this.loadFile();
        },

        loadFile() {
            // In production, this would fetch the file content from the API
            // For now, simulate loading with sample data
            this.loading = true;
            this.error = false;

            // Simulate API call delay
            setTimeout(() => {
                try {
                    // Sample content based on file type
                    if (this.getFileType(this.file.name) === 'json') {
                        this.content = JSON.stringify({
                            "job_id": "sample-job-123",
                            "status": "completed",
                            "sheets": [
                                {"id": 1, "status": "completed"},
                                {"id": 2, "status": "completed"}
                            ]
                        }, null, 2);
                    } else if (this.getFileType(this.file.name) === 'markdown') {
                        this.content = `# Sheet 1 Results

## Summary
This sheet completed successfully with the following outputs:

- Implementation complete
- All tests passing
- Documentation updated

## Details
The implementation followed the specified architecture patterns and completed without errors.

### Code Changes
\`\`\`python
def example_function():
    return "Hello, World!"
\`\`\`

### Next Steps
- Continue to sheet 2
- Review validation results`;
                    } else if (this.getFileType(this.file.name) === 'yaml') {
                        this.content = `job_name: sample-job
description: Sample Mozart job configuration
sheets:
  - name: "Initialize project"
    command: "echo 'Starting project...'"
    validation:
      - type: file_exists
        path: "README.md"
  - name: "Run tests"
    command: "pytest"
    validation:
      - type: command_success
        command: "pytest --tb=short"`;
                    } else {
                        this.content = `[2024-01-23 10:30:15] INFO: Job started successfully
[2024-01-23 10:30:16] DEBUG: Loading configuration from config.yaml
[2024-01-23 10:30:17] INFO: Executing sheet 1...
[2024-01-23 10:30:20] DEBUG: Running command: echo "Hello World"
[2024-01-23 10:30:21] INFO: Sheet 1 completed successfully
[2024-01-23 10:30:21] INFO: Executing sheet 2...
[2024-01-23 10:30:25] WARNING: Rate limit detected, waiting 30s...
[2024-01-23 10:30:55] INFO: Continuing execution...
[2024-01-23 10:31:00] INFO: Sheet 2 completed successfully
[2024-01-23 10:31:01] INFO: Job completed with status: SUCCESS`;
                    }

                    this.contentLines = this.content.split('\n');
                    this.loading = false;
                } catch (err) {
                    this.error = true;
                    this.errorMessage = 'Failed to load file content';
                    this.loading = false;
                }
            }, 1000);
        },

        retryLoad() {
            this.loadFile();
        },

        getFileType(filename) {
            const ext = filename.split('.').pop()?.toLowerCase();
            switch (ext) {
                case 'md': return 'markdown';
                case 'json': return 'json';
                case 'yaml':
                case 'yml': return 'yaml';
                case 'log': return 'log';
                case 'txt': return 'text';
                case 'py': return 'python';
                case 'js': return 'javascript';
                case 'html': return 'html';
                case 'css': return 'css';
                case 'png':
                case 'jpg':
                case 'jpeg':
                case 'gif':
                case 'svg': return 'image';
                default: return 'text';
            }
        },

        getFileTypeColor(filename) {
            const type = this.getFileType(filename);
            switch (type) {
                case 'markdown': return 'bg-blue-100 dark:bg-blue-900';
                case 'json': return 'bg-green-100 dark:bg-green-900';
                case 'yaml': return 'bg-purple-100 dark:bg-purple-900';
                case 'log': return 'bg-yellow-100 dark:bg-yellow-900';
                case 'python': return 'bg-green-100 dark:bg-green-900';
                case 'javascript': return 'bg-yellow-100 dark:bg-yellow-900';
                case 'image': return 'bg-pink-100 dark:bg-pink-900';
                default: return 'bg-gray-100 dark:bg-gray-800';
            }
        },

        getFileIconColor(filename) {
            const type = this.getFileType(filename);
            switch (type) {
                case 'markdown': return 'text-blue-600';
                case 'json': return 'text-green-600';
                case 'yaml': return 'text-purple-600';
                case 'log': return 'text-yellow-600';
                case 'python': return 'text-green-600';
                case 'javascript': return 'text-yellow-600';
                case 'image': return 'text-pink-600';
                default: return 'text-gray-600';
            }
        },

        getLanguageClass(filename) {
            const type = this.getFileType(filename);
            return `language-${type}`;
        },

        isTextFile(filename) {
            const textTypes = ['markdown', 'json', 'yaml', 'log', 'text', 'python', 'javascript', 'html', 'css'];
            return textTypes.includes(this.getFileType(filename));
        },

        isImageFile(filename) {
            return this.getFileType(filename) === 'image';
        },

        isPreviewable(filename) {
            const previewableTypes = ['markdown', 'json', 'yaml', 'log', 'text', 'python', 'javascript', 'html', 'css', 'image'];
            return previewableTypes.includes(this.getFileType(filename));
        },

        formatJson(content) {
            try {
                const parsed = JSON.parse(content);
                return JSON.stringify(parsed, null, 2);
            } catch {
                return content;
            }
        },

        renderMarkdown(content) {
            // Simple markdown rendering - in production, use a proper markdown library
            return content
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/```([^`]+)```/gim, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/gim, '<code>$1</code>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/\n/gim, '<br>');
        },

        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        getFileUrl(path) {
            return `/api/artifacts/${encodeURIComponent(path)}/raw`;
        },

        copyContent() {
            navigator.clipboard.writeText(this.content).then(() => {
                if (window.app && window.app.addNotification) {
                    window.app.addNotification({
                        type: 'success',
                        title: 'Copied',
                        message: 'File content copied to clipboard'
                    });
                }
            }).catch(() => {
                if (window.app && window.app.addNotification) {
                    window.app.addNotification({
                        type: 'error',
                        title: 'Copy Failed',
                        message: 'Could not copy content to clipboard'
                    });
                }
            });
        },

        downloadFile() {
            const link = document.createElement('a');
            link.href = `/api/artifacts/${encodeURIComponent(this.file.path)}/download`;
            link.download = this.file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        },

        handleImageError() {
            this.error = true;
            this.errorMessage = 'Could not load image';
        }
    }));
});
</script>