/**
 * CodeMirror 6 Bundle for Mozart Score Editor
 *
 * This is a custom build including:
 * - Core CodeMirror editor
 * - YAML language support
 * - Basic editor state and view
 * - Essential extensions for Mozart score editing
 *
 * Production build would use actual CodeMirror 6 package.
 * For now, this provides a minimal interface for the demo.
 */

window.CodeMirror6 = (function() {
    'use strict';

    // Mock EditorState constructor
    function EditorState(config) {
        this.doc = config.doc || '';
        this.selection = config.selection || { main: { from: 0, to: 0 } };
        this.extensions = config.extensions || [];
        this._facets = new Map();
    }

    EditorState.create = function(config) {
        return new EditorState(config);
    };

    // Mock EditorView constructor
    function EditorView(config) {
        this.state = config.state;
        this.parent = config.parent;
        this.dom = null;
        this._dispatch = config.dispatch || (() => {});
        this._extensions = [];

        this._createElement();
        if (this.parent) {
            this.parent.appendChild(this.dom);
        }
    }

    EditorView.prototype._createElement = function() {
        this.dom = document.createElement('div');
        this.dom.className = 'cm-editor cm-focused';
        this.dom.style.cssText = `
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-family: 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            min-height: 300px;
            background: #ffffff;
        `;

        const content = document.createElement('div');
        content.className = 'cm-content';
        content.style.cssText = `
            padding: 12px;
            outline: none;
            white-space: pre;
            overflow: auto;
            min-height: 276px;
        `;
        content.contentEditable = true;
        content.textContent = this.state.doc;

        // Basic event handling
        content.addEventListener('input', (e) => {
            const newDoc = e.target.textContent;
            this.state.doc = newDoc;
            this._dispatch({
                changes: { from: 0, to: this.state.doc.length, insert: newDoc }
            });
        });

        content.addEventListener('focus', () => {
            this.dom.classList.add('cm-focused');
        });

        content.addEventListener('blur', () => {
            this.dom.classList.remove('cm-focused');
        });

        this.dom.appendChild(content);
        this._content = content;
    };

    EditorView.prototype.dispatch = function(transaction) {
        if (transaction.changes) {
            this._content.textContent = transaction.changes.insert || this.state.doc;
        }
        this._dispatch(transaction);
    };

    EditorView.prototype.destroy = function() {
        if (this.dom && this.dom.parentNode) {
            this.dom.parentNode.removeChild(this.dom);
        }
    };

    // Mock extensions
    const basicSetup = [];

    const yaml = function() {
        return [];
    };

    const oneDark = {
        extension: [],
        theme: 'dark'
    };

    const EditorTheme = {
        baseTheme: function(theme) {
            return {
                '&': {
                    color: theme === 'dark' ? '#f8f8f2' : '#24292e',
                    backgroundColor: theme === 'dark' ? '#282a36' : '#ffffff'
                },
                '.cm-content': {
                    caretColor: theme === 'dark' ? '#f8f8f0' : '#24292e'
                },
                '.cm-cursor, .cm-dropCursor': {
                    borderLeftColor: theme === 'dark' ? '#f8f8f0' : '#24292e'
                },
                '.cm-selectionBackground, .cm-focused .cm-selectionBackground': {
                    backgroundColor: theme === 'dark' ? '#44475a' : '#b3d4fc'
                }
            };
        }
    };

    // Export public API
    return {
        EditorState: EditorState,
        EditorView: EditorView,
        basicSetup: basicSetup,
        yaml: yaml,
        oneDark: oneDark,
        EditorTheme: EditorTheme
    };
})();

// Initialize CodeMirror when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('CodeMirror 6 bundle loaded');
});