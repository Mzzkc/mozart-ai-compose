# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║       CONTINUOUS QUALITY: PHASE 3 HARDENING & WIRING                      ║
# ║                                                                            ║
# ║  Targeted quality review of Phase 3 daemon components:                    ║
# ║  - GlobalSheetScheduler: priority queue, fair-share, DAG deps             ║
# ║  - RateLimitCoordinator: cross-job rate limit sharing                     ║
# ║  - BackpressureController: memory-based load gating                       ║
# ║                                                                            ║
# ║  These components are fully built & tested (~840 LOC, ~71 tests)          ║
# ║  but NOT wired into the execution path. This score:                       ║
# ║    Iterations 1-3: HARDEN (edge cases, stress tests, protocol gaps)       ║
# ║    Iterations 4+:  WIRE (connect to live execution path)                  ║
# ║                                                                            ║
# ║  Branch protocol:                                                          ║
# ║    Stage 1 checks out daemon-symphony; stages 1-11 STAY on it            ║
# ║    Stage 2 (parallel) is READ-ONLY — no branch switching                  ║
# ║    Stages 12-14 manage branch state independently                         ║
# ║                                                                            ║
# ║  Execution Flow (14 stages, 17 concrete sheets):                          ║
# ║                                                                            ║
# ║    Stage 1:  Phase 3 Deep Inventory                                       ║
# ║         |                                                                  ║
# ║         +------+-------+-------+                                          ║
# ║         v      v       v       v                                          ║
# ║    Stage 2 x4: Component Deep-Dives (PARALLEL)                           ║
# ║      [Scheduler] [RateCoord] [Backpressure] [IntegrationGaps]            ║
# ║         |      |       |       |                                          ║
# ║         +------+-------+-------+                                          ║
# ║                   v                                                        ║
# ║    Stage 3:  Gap Analysis & Hardening Plan                                ║
# ║    Stage 4:  Hardening Prioritization                                     ║
# ║    Stage 5:  Batch 1 — Edge Cases & Protocol Compliance (70%+)           ║
# ║    Stage 6:  Batch 1 — Completion Pass                                    ║
# ║    Stage 7:  Batch 2 — Stress Tests & Concurrency (70%+)                 ║
# ║    Stage 8:  Batch 2 — Completion Pass                                    ║
# ║    Stage 9:  Batch 3 — Wiring Prep / Live Integration (50%+)             ║
# ║    Stage 10: Batch 3 — Completion Pass                                    ║
# ║    Stage 11: Verification & Summary                                       ║
# ║    Stage 12: Commit & Push (to daemon-symphony)                           ║
# ║    Stage 13: Merge Conflict Resolution                                    ║
# ║    Stage 14: Final Integration Verification                               ║
# ║                                                                            ║
# ║  Usage:                                                                    ║
# ║    cd ~/Projects/mozart-ai-compose                                         ║
# ║    setsid mozart run examples/quality-continuous-daemon.yaml \             ║
# ║      > .quality-daemon-workspace/mozart.log 2>&1 &                        ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: "quality-continuous-daemon"
description: "Phase 3 hardening & wiring — scheduler, rate coordinator, backpressure"

workspace: "./.quality-daemon-workspace"

workspace_lifecycle:
  archive_on_fresh: true
  max_archives: 5

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: /home/emzi/Projects/mozart-ai-compose
  timeout_seconds: 3000

cross_sheet:
  auto_capture_stdout: true
  max_output_chars: 3000
  lookback_sheets: 5
  capture_files:
    - "{{ workspace }}/*.md"
    - "{{ workspace }}/*.yaml"

sheet:
  size: 1
  total_items: 14

  fan_out:
    2: 4

  dependencies:
    2: [1]
    3: [2]
    4: [3]
    5: [4]
    6: [5]
    7: [6]
    8: [7]
    9: [8]
    10: [9]
    11: [10]
    12: [11]
    13: [12]
    14: [13]

parallel:
  enabled: true
  max_concurrent: 4

retry:
  max_retries: 2

prompt:
  template: |
    {{ preamble }}

    {% if stage == 1 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 1: PHASE 3 DEEP INVENTORY                                          ║
    ║  "Know exactly what exists before you touch anything"                      ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    **Step 1: Track iteration and determine mode**
    ```bash
    mkdir -p {{ workspace }}
    if [ -f {{ workspace }}/.p3-iteration ]; then
      ITER=$(cat {{ workspace }}/.p3-iteration)
      ITER=$((ITER + 1))
    else
      ITER=1
    fi
    echo $ITER > {{ workspace }}/.p3-iteration
    if [ $ITER -le 3 ]; then
      MODE="HARDEN"
      echo "=== PHASE 3 QUALITY ITERATION $ITER (MODE: HARDEN) ==="
      echo "Focus: edge cases, stress tests, protocol compliance, missing tests"
    else
      MODE="WIRE"
      echo "=== PHASE 3 QUALITY ITERATION $ITER (MODE: WIRE) ==="
      echo "Focus: connect scheduler/rate-coord/backpressure to live execution"
    fi
    echo "$MODE" > {{ workspace }}/.p3-mode
    ```

    **Step 2: Inventory Phase 3 components**
    ```bash
    echo "=== PHASE 3 COMPONENT FILES ==="
    wc -l src/mozart/daemon/scheduler.py \
          src/mozart/daemon/rate_coordinator.py \
          src/mozart/daemon/backpressure.py

    echo "=== PHASE 3 TEST FILES ==="
    wc -l tests/test_daemon_scheduler.py \
          tests/test_daemon_rate_coordinator.py \
          tests/test_daemon_backpressure.py

    echo "=== RELATED FILES (execution path) ==="
    wc -l src/mozart/daemon/manager.py \
          src/mozart/daemon/job_service.py

    echo "=== WIRING STATUS: scheduler ==="
    grep -n "scheduler\|GlobalSheetScheduler\|next_sheet\|register_job" \
      src/mozart/daemon/manager.py src/mozart/daemon/job_service.py 2>/dev/null | head -20

    echo "=== WIRING STATUS: rate_coordinator ==="
    grep -n "rate_coordinator\|RateLimitCoordinator\|report_rate_limit\|is_rate_limited" \
      src/mozart/daemon/manager.py src/mozart/daemon/job_service.py 2>/dev/null | head -20

    echo "=== WIRING STATUS: backpressure ==="
    grep -n "backpressure\|BackpressureController\|should_accept\|can_start_sheet" \
      src/mozart/daemon/manager.py src/mozart/daemon/job_service.py 2>/dev/null | head -20
    ```

    **Step 3: Read each Phase 3 component in full**
    - `src/mozart/daemon/scheduler.py` — GlobalSheetScheduler
    - `src/mozart/daemon/rate_coordinator.py` — RateLimitCoordinator
    - `src/mozart/daemon/backpressure.py` — BackpressureController
    - `src/mozart/daemon/manager.py` — JobManager (wiring target)
    - `src/mozart/daemon/job_service.py` — JobService (execution entry)

    **Step 4: Run Phase 3 tests to establish baseline**
    ```bash
    echo "=== SCHEDULER TESTS ==="
    pytest tests/test_daemon_scheduler.py -v --tb=short 2>&1 | tail -30
    echo "=== RATE COORDINATOR TESTS ==="
    pytest tests/test_daemon_rate_coordinator.py -v --tb=short 2>&1 | tail -30
    echo "=== BACKPRESSURE TESTS ==="
    pytest tests/test_daemon_backpressure.py -v --tb=short 2>&1 | tail -30
    echo "=== FULL SUITE ==="
    pytest tests/ -x --timeout=120 -q --tb=line 2>&1 | tail -5
    ```

    Save to {{ workspace }}/00-phase3-inventory.md with: Mode, Component Stats table,
    Wiring Status table, API Surface Summary, Test Baseline, Key Concerns.

    **Output to:** {{ workspace }}/00-phase3-inventory.md

    {% elif stage == 2 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 2: COMPONENT DEEP-DIVE — {{ review_types[instance] | upper }}        ║
    ║  Instance {{ instance }} of {{ fan_count }} (running in PARALLEL)            ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}
    {{ readonly_constraint }}

    **Read:** {{ workspace }}/00-phase3-inventory.md and {{ workspace }}/.p3-mode

    {% if instance == 1 %}
    {# ═══════════════ SCHEDULER DEEP-DIVE ═══════════════ #}

    You are the **Scheduler Deep-Dive Analyst**. Find every edge case,
    protocol gap, and potential failure in GlobalSheetScheduler.

    **Read in full:** `src/mozart/daemon/scheduler.py` and `tests/test_daemon_scheduler.py`

    **1. API Contract Verification**
    For each public method (register_job, deregister_job, next_sheet,
    mark_complete, get_stats): empty/None input? duplicate calls? wrong order?

    **2. Priority Calculation** — _calculate_priority math correct?
    _fair_share prevents starvation? heapq min/max-heap correct?

    **3. DAG Dependencies** — circular deps detected? nonexistent sheet deps?
    mark_complete on already-completed? _enqueue_ready_dependents edge cases?

    **4. Concurrency** — register_job vs next_sheet race? mark_complete vs
    deregister_job race? 10 concurrent next_sheet? TOCTOU in rate_limiter check?
    ```bash
    grep -n "self._lock\|async with" src/mozart/daemon/scheduler.py
    ```

    **5. Rate Limit & Backpressure Integration** — what if checkers raise?
    set_rate_limiter mid-scheduling safe?

    **6. Missing Tests** — list every untested scenario.

    **Output to:** {{ workspace }}/01-scheduler-deep-dive.md

    {% elif instance == 2 %}
    {# ═══════════════ RATE COORDINATOR DEEP-DIVE ═══════════════ #}

    You are the **Rate Coordinator Deep-Dive Analyst**. Find every edge case
    in RateLimitCoordinator.

    **Read in full:** `src/mozart/daemon/rate_coordinator.py` and `tests/test_daemon_rate_coordinator.py`

    **1. Report → Check Round-Trip** — backend isolation? concurrent reports?
    time-based expiry? report A doesn't affect B?

    **2. Concurrent Access** — 10 concurrent reports? is_rate_limited during
    report? prune_stale during add? wait_if_limited multiple waiters?
    ```bash
    grep -n "self._lock\|async with" src/mozart/daemon/rate_coordinator.py
    ```

    **3. Stale Events** — prune threshold correct? memory leak without pruning?
    very large suggested_wait_seconds?

    **4. is_limited_sync vs is_rate_limited** — why both? consistent? contradictory?

    **5. wait_if_limited** — blocks until expiry? new limit extends wait?
    max wait time? shutdown while waiting?

    **6. Missing Tests** — list every untested scenario.

    **Output to:** {{ workspace }}/02-rate-coordinator-deep-dive.md

    {% elif instance == 3 %}
    {# ═══════════════ BACKPRESSURE DEEP-DIVE ═══════════════ #}

    You are the **Backpressure Deep-Dive Analyst**. Find every edge case
    in BackpressureController.

    **Read in full:** `src/mozart/daemon/backpressure.py` and `tests/test_daemon_backpressure.py`

    **1. Pressure Levels** — trigger conditions? thresholds configurable/hardcoded?
    exact boundary values? skip levels? decrease levels?
    ```bash
    grep -n "PressureLevel\|_LEVEL_DELAYS\|threshold\|percent" src/mozart/daemon/backpressure.py
    ```

    **2. Monitor Dependency** — monitor raises? returns None? memory > 100%?

    **3. Rate Coordinator Integration** — how used? active limits raise pressure?
    rate_coordinator is None? **Is this branch tested or dead code?**
    ```bash
    grep -n "rate_coordinator\|_rate_coordinator" src/mozart/daemon/backpressure.py
    ```

    **4. can_start_sheet Gating** — return at each level? delays? CRITICAL blocks?

    **5. should_accept_job** — rejection level? logging? permanent vs temporary?

    **6. Rapid Oscillation** — boundary bouncing? hysteresis? performance?

    **7. Missing Tests** — list every untested scenario.

    **Output to:** {{ workspace }}/03-backpressure-deep-dive.md

    {% elif instance == 4 %}
    {# ═══════════════ INTEGRATION GAPS DEEP-DIVE ═══════════════ #}

    You are the **Integration Gaps Analyst**. Map what's needed to wire
    Phase 3 components into the live execution path.

    **Read in full:**
    - `src/mozart/daemon/manager.py` — JobManager
    - `src/mozart/daemon/job_service.py` — JobService
    - `src/mozart/daemon/process.py` — DaemonProcess startup
    - `src/mozart/daemon/scheduler.py`, `rate_coordinator.py`, `backpressure.py`

    **1. Current Execution Flow** — trace submit → _run_job_task → sheets
    ```bash
    grep -n "async def.*run\|_run_job_task\|submit_job" src/mozart/daemon/manager.py | head -20
    grep -n "async def.*run\|_execute\|_run_sheet" src/mozart/daemon/job_service.py | head -20
    ```

    **2. Scheduler Wiring** — where does sheet decomposition happen?
    Where should register_job/next_sheet/mark_complete be called?

    **3. Rate Coordinator Wiring** — where are rate limits detected?
    ```bash
    grep -rn "rate.limit\|429\|too.many\|RateLimit" src/mozart/ --include="*.py" | head -20
    ```

    **4. Backpressure Wiring** — where should should_accept_job gate?
    Where should can_start_sheet gate?

    **5. Interface Compatibility** — do SheetInfo/RateLimitEvent/Protocols match?

    **6. Required Glue Code** — adapters, callbacks, new interfaces needed?

    **Output to:** {{ workspace }}/04-integration-gaps.md

    {% endif %}

    {% elif stage == 3 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 3: GAP ANALYSIS (up to 25 Work Items from Deep-Dives)               ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    {% if previous_outputs %}
    {{ previous_outputs[2][:600] if 2 in previous_outputs else "" }}
    {{ previous_outputs[3][:600] if 3 in previous_outputs else "" }}
    {{ previous_outputs[4][:600] if 4 in previous_outputs else "" }}
    {{ previous_outputs[5][:600] if 5 in previous_outputs else "" }}
    {% endif %}

    **Read the COMPLETE files:**
    - {{ workspace }}/00-phase3-inventory.md
    - {{ workspace }}/01-scheduler-deep-dive.md
    - {{ workspace }}/02-rate-coordinator-deep-dive.md
    - {{ workspace }}/03-backpressure-deep-dive.md
    - {{ workspace }}/04-integration-gaps.md
    - {{ workspace }}/.p3-mode

    Select **up to 25 actionable work items**.

    **HARDEN mode priorities:** EdgeCase, MissingTest, ProtocolGap, ConcurrencyBug, DeadCode
    **WIRE mode priorities:** WiringPrereq, WiringPoint, IntegrationTest, BackwardsCompat

    **Categories:** EdgeCase, MissingTest, ProtocolGap, ConcurrencyBug,
    DeadCode, WiringPrereq, WiringPoint, IntegrationTest, StressTest, Cleanup

    **Output to:** {{ workspace }}/05-gap-analysis.yaml
    Format: `issues: [{id: P001, source, category, file, line, severity, description, suggested_fix, fix_effort}]`

    {% elif stage == 4 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 4: HARDENING PRIORITIZATION                                          ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/05-gap-analysis.yaml and {{ workspace }}/.p3-mode.

    **Score:** `severity × (1/effort)` + mode bonuses:
    - HARDEN: +2 EdgeCase/ProtocolGap/ConcurrencyBug, +1 MissingTest/StressTest
    - WIRE: +2 WiringPoint/WiringPrereq, +1 IntegrationTest

    **Batch into 3 groups:**
    - Batch 1: Quick wins (edge cases, simple tests)
    - Batch 2: Medium (stress tests, concurrency fixes)
    - Batch 3: Significant (wiring prep or actual wiring)

    **Output to:** {{ workspace }}/06-hardening-plan.md

    {% elif stage == 5 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 5: BATCH 1 — EDGE CASES & PROTOCOL COMPLIANCE (70%+ REQUIRED)       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/06-hardening-plan.md and fix Batch 1 issues.
    **MANDATORY: Complete at least 70% of Batch 1 issues.**

    Scope: Only `src/mozart/daemon/` and `tests/test_daemon_*.py`.

    {{ batch_rules }}

    **Output to:** {{ workspace }}/07-batch1-fixes.md
    Format: `**Total:** N` / `**Fixed:** N` / `**Completion:** N%` + Fixed/Deferred tables.

    {% elif stage == 6 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 6: BATCH 1 — COMPLETION PASS                                        ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/07-batch1-fixes.md. Complete ALL deferred items.
    ```bash
    pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py \
      tests/test_daemon_backpressure.py -v --tb=short 2>&1 | tail -20
    pytest tests/ -x --timeout=120 -q 2>&1 | tail -5
    ```

    **Output to:** {{ workspace }}/08-batch1-completion.md

    {% elif stage == 7 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 7: BATCH 2 — STRESS TESTS & CONCURRENCY (70%+ REQUIRED)             ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/06-hardening-plan.md. Fix Batch 2 issues.
    **MANDATORY: Complete at least 70%.**

    Focus: stress tests (50+ sheets, 10+ jobs), concurrent report/check,
    rapidly changing resource levels, deadlock detection with asyncio.wait_for.

    {{ batch_rules }}

    **Output to:** {{ workspace }}/09-batch2-fixes.md
    Format: `**Total:** N` / `**Fixed:** N` / `**Completion:** N%` + tables.

    {% elif stage == 8 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 8: BATCH 2 — COMPLETION PASS                                        ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/09-batch2-fixes.md. Complete ALL deferred items.
    ```bash
    pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py \
      tests/test_daemon_backpressure.py -v --tb=short 2>&1 | tail -20
    pytest tests/ -x --timeout=120 -q 2>&1 | tail -5
    ```

    **Output to:** {{ workspace }}/10-batch2-completion.md

    {% elif stage == 9 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 9: BATCH 3 — WIRING PREP / LIVE INTEGRATION (50%+ REQUIRED)         ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/06-hardening-plan.md and {{ workspace }}/.p3-mode.
    **MANDATORY: Complete at least 50%.**

    **HARDEN mode:** Create adapter interfaces, add integration tests for future
    wiring, stabilize APIs, document wiring points.
    **WIRE mode:** Connect scheduler→_run_job_task, rate_coord→backend errors,
    backpressure→submission gate. Add integration tests. Keep non-daemon working.

    {{ batch_rules }}

    **Output to:** {{ workspace }}/11-batch3-fixes.md
    Format: `**Total:** N` / `**Fixed:** N` / `**Completion:** N%` + tables.

    {% elif stage == 10 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 10: BATCH 3 — COMPLETION PASS                                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/11-batch3-fixes.md. Complete ALL deferred items.
    ```bash
    pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py \
      tests/test_daemon_backpressure.py -v --tb=short 2>&1 | tail -30
    pytest tests/ -x --timeout=120 -q 2>&1 | tail -5
    ```

    **Output to:** {{ workspace }}/12-batch3-completion.md

    {% elif stage == 11 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 11: VERIFICATION & SUMMARY                                           ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    ```bash
    pytest --tb=short 2>&1 | tee {{ workspace }}/13-test-output.txt | tail -50
    ```
    ```bash
    pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py \
      tests/test_daemon_backpressure.py -v --tb=short 2>&1 | tail -40
    ```
    ```bash
    mypy src/mozart/daemon/scheduler.py src/mozart/daemon/rate_coordinator.py \
      src/mozart/daemon/backpressure.py --ignore-missing-imports 2>&1 | tail -20
    ```
    ```bash
    ruff check src/mozart/daemon/scheduler.py src/mozart/daemon/rate_coordinator.py \
      src/mozart/daemon/backpressure.py 2>&1 | tail -20
    ```
    ```bash
    python -c "
    from mozart.daemon.scheduler import GlobalSheetScheduler
    from mozart.daemon.rate_coordinator import RateLimitCoordinator
    from mozart.daemon.backpressure import BackpressureController
    print('Phase 3 imports OK')
    "
    ```
    ```bash
    mozart validate examples/sheet-review.yaml --json 2>/dev/null
    test $? -le 1 && echo "CLI canary PASSED" || echo "CLI canary FAILED"
    ```

    Create summary with: Phase 3 test counts (before→after), issues by category,
    issues fixed per batch, wiring status update, production readiness, verdict.

    **Output to:** {{ workspace }}/13-summary.md

    {% elif stage == 12 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 12: COMMIT CHANGES TO DAEMON-SYMPHONY                               ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    ```bash
    git status --short | grep -E "\.py$" | head -30
    ```

    Read batch files (07 through 13) and build commit message listing every
    fixed issue by ID. Write to {{ workspace }}/14-commit-message.txt.

    Stage ONLY touched .py files explicitly. Sync with remote, commit, push.
    ```bash
    git commit -F {{ workspace }}/14-commit-message.txt
    git push origin daemon-symphony
    ```

    **Output to:** {{ workspace }}/14-commit.md

    {{ branch_return }}

    {% elif stage == 13 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 13: MERGE CONFLICT RESOLUTION                                        ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    Read {{ workspace }}/14-commit.md. If "committed" → pass-through.
    If "conflicts_pending" → resolve, test, commit, push.

    **Output to:** {{ workspace }}/15-merge-resolution.md

    {{ branch_return }}

    {% elif stage == 14 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  STAGE 14: FINAL INTEGRATION VERIFICATION                                   ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {{ branch_checkout }}

    ```bash
    pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py \
      tests/test_daemon_backpressure.py -v --tb=short 2>&1 | tail -40
    pytest tests/test_daemon_*.py -v --tb=short 2>&1 | tail -40
    pytest tests/ -x --timeout=120 -q 2>&1 | tail -10
    python -c "
    from mozart.daemon.config import DaemonConfig
    from mozart.daemon.process import DaemonProcess
    from mozart.daemon.manager import JobManager
    from mozart.daemon.monitor import ResourceMonitor
    from mozart.daemon.scheduler import GlobalSheetScheduler
    from mozart.daemon.rate_coordinator import RateLimitCoordinator
    from mozart.daemon.backpressure import BackpressureController
    from mozart.daemon.learning_hub import LearningHub
    from mozart.daemon.ipc.server import IPCServer
    from mozart.daemon.ipc.client import IPCClient
    print('ALL DAEMON IMPORTS OK')
    " 2>&1
    mozart validate examples/sheet-review.yaml --json 2>/dev/null
    echo "Exit code: $?"
    echo "Scheduler tests:"
    pytest tests/test_daemon_scheduler.py -q --tb=no 2>&1 | tail -1
    echo "Rate coordinator tests:"
    pytest tests/test_daemon_rate_coordinator.py -q --tb=no 2>&1 | tail -1
    echo "Backpressure tests:"
    pytest tests/test_daemon_backpressure.py -q --tb=no 2>&1 | tail -1
    ```

    **Output to:** {{ workspace }}/16-final-verification.md

    {{ branch_return }}

    {% endif %}

  variables:
    preamble: |
      ╔══════════════════════════════════════════════════════════════════════════╗
      ║       PHASE 3 HARDENING & WIRING                                      ║
      ║  Scheduler · Rate Coordinator · Backpressure                          ║
      ║  Built & tested, NOT wired. HARDEN then WIRE.                        ║
      ╚══════════════════════════════════════════════════════════════════════════╝

      **Project:** /home/emzi/Projects/mozart-ai-compose
      **Branch:** daemon-symphony (return to main at end)

    review_types:
      1: "Scheduler"
      2: "Rate Coordinator"
      3: "Backpressure"
      4: "Integration Gaps"

    branch_checkout: |
      **Branch Protocol:**
      ```bash
      cd /home/emzi/Projects/mozart-ai-compose
      git checkout daemon-symphony 2>/dev/null || true
      echo "Branch: $(git branch --show-current)"
      ```
      NEVER commit to `main`. NEVER use `git add .` or `git add -A`.

    readonly_constraint: |
      **READ-ONLY stage (PARALLEL). Do NOT modify src/ or tests/.**
      **Do NOT run git write operations. ONLY write your output file.**

    branch_return: |
      ```bash
      cd /home/emzi/Projects/mozart-ai-compose && git checkout main
      ```

    batch_rules: |
      **Rules:**
      - Run Phase 3 tests after each change:
        `pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py tests/test_daemon_backpressure.py -x -q --tb=short`
      - Run full suite periodically: `pytest -x -q --tb=short`
      - DO NOT SKIP unless genuinely blocked with evidence
      - INVALID skips: "Risky", "Low benefit", "Extensive testing needed", "Better for future"

validations:
  - type: file_exists
    path: "{workspace}/00-phase3-inventory.md"
    description: "Phase 3 inventory must exist"
    condition: "stage >= 1"

  - type: file_exists
    path: "{workspace}/01-scheduler-deep-dive.md"
    description: "Scheduler deep-dive must exist"
    condition: "stage == 2 and instance == 1"

  - type: file_exists
    path: "{workspace}/02-rate-coordinator-deep-dive.md"
    description: "Rate coordinator deep-dive must exist"
    condition: "stage == 2 and instance == 2"

  - type: file_exists
    path: "{workspace}/03-backpressure-deep-dive.md"
    description: "Backpressure deep-dive must exist"
    condition: "stage == 2 and instance == 3"

  - type: file_exists
    path: "{workspace}/04-integration-gaps.md"
    description: "Integration gaps must exist"
    condition: "stage == 2 and instance == 4"

  - type: file_exists
    path: "{workspace}/05-gap-analysis.yaml"
    description: "Gap analysis must exist"
    condition: "stage >= 3"

  - type: file_exists
    path: "{workspace}/06-hardening-plan.md"
    description: "Hardening plan must exist"
    condition: "stage >= 4"

  - type: file_exists
    path: "{workspace}/07-batch1-fixes.md"
    description: "Batch 1 results must exist"
    condition: "stage >= 5"

  - type: command_succeeds
    command: |
      FILE="{workspace}/07-batch1-fixes.md"
      if [ ! -f "$FILE" ]; then exit 1; fi
      COMPLETION=$(grep -oE 'Completion.*[0-9]+%' "$FILE" | grep -oE '[0-9]+' | head -1)
      if [ -z "$COMPLETION" ]; then
        FIXED=$(grep -E '^\*\*Fixed:\*\*' "$FILE" | grep -oE '[0-9]+' | head -1)
        TOTAL=$(grep -E '^\*\*Total:\*\*' "$FILE" | grep -oE '[0-9]+' | head -1)
        if [ -n "$FIXED" ] && [ -n "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
          COMPLETION=$((FIXED * 100 / TOTAL))
        fi
      fi
      [ -n "$COMPLETION" ] && [ "$COMPLETION" -ge 70 ]
    description: "Batch 1 >=70% completion"
    condition: "stage >= 5"

  - type: file_exists
    path: "{workspace}/08-batch1-completion.md"
    description: "Batch 1 completion must exist"
    condition: "stage >= 6"

  - type: file_exists
    path: "{workspace}/09-batch2-fixes.md"
    description: "Batch 2 results must exist"
    condition: "stage >= 7"

  - type: command_succeeds
    command: |
      FILE="{workspace}/09-batch2-fixes.md"
      if [ ! -f "$FILE" ]; then exit 1; fi
      COMPLETION=$(grep -oE 'Completion.*[0-9]+%' "$FILE" | grep -oE '[0-9]+' | head -1)
      if [ -z "$COMPLETION" ]; then
        FIXED=$(grep -E '^\*\*Fixed:\*\*' "$FILE" | grep -oE '[0-9]+' | head -1)
        TOTAL=$(grep -E '^\*\*Total:\*\*' "$FILE" | grep -oE '[0-9]+' | head -1)
        if [ -n "$FIXED" ] && [ -n "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
          COMPLETION=$((FIXED * 100 / TOTAL))
        fi
      fi
      [ -n "$COMPLETION" ] && [ "$COMPLETION" -ge 70 ]
    description: "Batch 2 >=70% completion"
    condition: "stage >= 7"

  - type: file_exists
    path: "{workspace}/10-batch2-completion.md"
    description: "Batch 2 completion must exist"
    condition: "stage >= 8"

  - type: file_exists
    path: "{workspace}/11-batch3-fixes.md"
    description: "Batch 3 results must exist"
    condition: "stage >= 9"

  - type: command_succeeds
    command: |
      FILE="{workspace}/11-batch3-fixes.md"
      if [ ! -f "$FILE" ]; then exit 1; fi
      COMPLETION=$(grep -oE 'Completion.*[0-9]+%' "$FILE" | grep -oE '[0-9]+' | head -1)
      if [ -z "$COMPLETION" ]; then
        FIXED=$(grep -E '^\*\*Fixed:\*\*' "$FILE" | grep -oE '[0-9]+' | head -1)
        TOTAL=$(grep -E '^\*\*Total:\*\*' "$FILE" | grep -oE '[0-9]+' | head -1)
        if [ -n "$FIXED" ] && [ -n "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
          COMPLETION=$((FIXED * 100 / TOTAL))
        fi
      fi
      [ -n "$COMPLETION" ] && [ "$COMPLETION" -ge 50 ]
    description: "Batch 3 >=50% completion"
    condition: "stage >= 9"

  - type: file_exists
    path: "{workspace}/12-batch3-completion.md"
    description: "Batch 3 completion must exist"
    condition: "stage >= 10"

  - type: file_exists
    path: "{workspace}/13-summary.md"
    description: "Summary must exist"
    condition: "stage >= 11"

  - type: file_exists
    path: "{workspace}/14-commit.md"
    description: "Commit report must exist"
    condition: "stage >= 12"

  - type: file_exists
    path: "{workspace}/15-merge-resolution.md"
    description: "Merge resolution must exist"
    condition: "stage >= 13"

  - type: file_exists
    path: "{workspace}/16-final-verification.md"
    description: "Final verification must exist"
    condition: "stage >= 14"

  - type: command_succeeds
    command: "cd /home/emzi/Projects/mozart-ai-compose && git checkout daemon-symphony -q && .venv/bin/pytest -x -q --tb=no 2>&1 | tail -1 | grep -qE 'passed' ; _r=$?; git checkout main -q; exit $_r"
    description: "Tests pass on daemon-symphony"
    condition: "stage == 14"

  - type: command_succeeds
    command: "cd /home/emzi/Projects/mozart-ai-compose && git checkout daemon-symphony -q && .venv/bin/python -c 'from mozart.daemon.scheduler import GlobalSheetScheduler; from mozart.daemon.rate_coordinator import RateLimitCoordinator; from mozart.daemon.backpressure import BackpressureController; print(\"OK\")' ; _r=$?; git checkout main -q; exit $_r"
    description: "Phase 3 imports succeed"
    condition: "stage >= 14"

  - type: command_succeeds
    command: "cd /home/emzi/Projects/mozart-ai-compose && git checkout main -q && .venv/bin/mozart validate examples/sheet-review.yaml --json 2>/dev/null; test $? -le 1"
    description: "CLI canary on main"
    condition: "stage >= 14"

  - type: command_succeeds
    command: "cd /home/emzi/Projects/mozart-ai-compose && git checkout daemon-symphony -q && .venv/bin/pytest tests/ -x --timeout=120 -q --tb=line --no-header 2>&1 | tail -1 | grep -qE '[0-9]+ passed' ; _r=$?; git checkout main -q; exit $_r"
    description: "Full suite passes on daemon-symphony"
    condition: "stage >= 14"

  - type: command_succeeds
    command: "cd /home/emzi/Projects/mozart-ai-compose && git checkout daemon-symphony -q && .venv/bin/pytest tests/test_daemon_scheduler.py tests/test_daemon_rate_coordinator.py tests/test_daemon_backpressure.py -q --tb=no --no-header 2>&1 | tail -1 | grep -qoE '[0-9]+ passed' ; _r=$?; git checkout main -q; exit $_r"
    description: "Phase 3 component tests pass"
    condition: "stage >= 14"

on_success:
  - type: run_job
    job_path: "examples/quality-continuous-daemon.yaml"
    description: "Chain to next Phase 3 iteration"
    detached: true
    fresh: true
    job_workspace: ".quality-daemon-workspace"

concert:
  enabled: true
  max_chain_depth: 10
  cooldown_between_jobs_seconds: 120
  inherit_workspace: false
