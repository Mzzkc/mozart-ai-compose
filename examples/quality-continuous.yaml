# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║              CONTINUOUS QUALITY IMPROVEMENT                                  ║
# ║                                                                              ║
# ║  Generic quality review that chains into itself for continuous improvement   ║
# ║  Can be used on ANY Python project                                           ║
# ║                                                                              ║
# ║  Usage:                                                                      ║
# ║    cd /path/to/your/project                                                  ║
# ║    mozart run /path/to/examples/quality-continuous.yaml                      ║
# ║                                                                              ║
# ║  The job will:                                                               ║
# ║    1. Discover issues across 10 categories                                   ║
# ║    2. Fix issues in batches (quick wins → medium → significant)              ║
# ║    3. Verify tests still pass                                                ║
# ║    4. Commit changes with summary                                            ║
# ║    5. Chain to next iteration (up to 10 total)                               ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: "quality-continuous"
description: "Continuous quality improvement - finds, fixes, and commits issues iteratively"

workspace: "./.quality-workspace"

backend:
  type: claude_cli
  skip_permissions: true
  timeout_seconds: 1800

cross_sheet:
  auto_capture_stdout: true
  max_output_chars: 2000
  lookback_sheets: 1

sheet:
  size: 1
  total_items: 6

retry:
  max_retries: 2

prompt:
  template: |
    {{ preamble }}

    {% if sheet_num == 1 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 1: DISCOVER ISSUES                                                    ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Step 0: Track iteration**
    ```bash
    mkdir -p {{ workspace }}
    if [ -f {{ workspace }}/.iteration ]; then
      ITER=$(cat {{ workspace }}/.iteration)
      ITER=$((ITER + 1))
    else
      ITER=1
    fi
    echo $ITER > {{ workspace }}/.iteration
    echo "=== QUALITY ITERATION $ITER ==="
    ```

    **Step 1: Understand the project**
    ```bash
    ls -la src/ 2>/dev/null || ls -la lib/ 2>/dev/null || ls -la .
    find . -name "*.py" -type f | wc -l
    ```

    **Step 2: Find 20 issues across 10 categories (2 per category)**

    Categories:
    1. Dead Code - unused imports, unreachable code
    2. Complexity - functions >50 LOC, deep nesting
    3. Naming - unclear or inconsistent names
    4. Error Handling - bare excepts, swallowed errors
    5. Type Safety - missing hints, Any abuse
    6. Duplication - copy-paste code patterns
    7. Documentation - missing/stale docstrings
    8. Testing Gaps - untested code paths
    9. Performance - O(n²) loops, repeated work
    10. Security - path injection, unsafe defaults

    **Output to:** {{ workspace }}/01-issues.yaml

    ```yaml
    iteration: N
    issues:
      - id: Q001
        category: Dead Code
        file: path/to/file.py
        line: N
        severity: critical | high | medium | low
        description: Brief description
        fix_effort: quick | medium | significant
    ```

    {% elif sheet_num == 2 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 2: QUICK WINS                                                         ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    Read {{ workspace }}/01-issues.yaml

    **Fix all `fix_effort: quick` issues:**
    - Unused imports
    - Simple type hints
    - Dead code removal
    - Basic docstrings

    **Rules:**
    - Minimal changes only
    - Test after each fix
    - Skip risky changes

    **Output to:** {{ workspace }}/02-quick-wins.md

    {% elif sheet_num == 3 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 3: MEDIUM EFFORT                                                      ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Fix `fix_effort: medium` issues:**
    - Error handling improvements
    - Function decomposition
    - Duplicate extraction

    **Output to:** {{ workspace }}/03-medium-fixes.md

    {% elif sheet_num == 4 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 4: SIGNIFICANT FIXES                                                  ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Fix `fix_effort: significant` issues:**
    - Write missing tests
    - Refactor complex functions
    - Fix security issues

    **Be conservative - skip major architectural changes.**

    **Output to:** {{ workspace }}/04-significant-fixes.md

    {% elif sheet_num == 5 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 5: VERIFY & SUMMARIZE                                                 ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Run full test suite:**
    ```bash
    pytest --tb=short 2>&1 | tail -50
    ```

    **Create summary:**

    **Output to:** {{ workspace }}/05-summary.md

    ```markdown
    # Quality Iteration N Summary

    ## Issues Found: N
    ## Issues Fixed: N
    ## Issues Skipped: N

    ## Changes Made
    - [list of changes]

    ## Test Results
    [pytest output]
    ```

    {% elif sheet_num == 6 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 6: COMMIT CHANGES                                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Step 1: Check for changes**
    ```bash
    git status --short
    ```

    **Step 2: If there are changes, commit them**

    Read {{ workspace }}/05-summary.md for the commit message content.

    ```bash
    # Stage all changed Python files (not workspace files)
    git add -A -- '*.py'

    # Check what's staged
    git diff --cached --stat

    # Create commit with iteration number
    ITER=$(cat {{ workspace }}/.iteration)
    git commit -m "refactor: Quality iteration $ITER improvements

    $(cat {{ workspace }}/05-summary.md | head -30)

    Co-Authored-By: Mozart Quality Score <noreply@mozart.ai>"
    ```

    **Step 3: Verify commit succeeded**
    ```bash
    git log --oneline -1
    ```

    **Output to:** {{ workspace }}/06-commit.md

    ```markdown
    # Commit Results

    ## Staged Files
    [list]

    ## Commit Hash
    [hash]

    ## Commit Message
    [message]
    ```

    {% endif %}

  variables:
    preamble: |
      ╔══════════════════════════════════════════════════════════════════════════╗
      ║              CONTINUOUS QUALITY IMPROVEMENT                              ║
      ║  Find issues → Fix issues → Verify → Commit → Repeat                    ║
      ╚══════════════════════════════════════════════════════════════════════════╝

      **Principles:**
      1. Minimal, targeted changes
      2. Test after every change
      3. Skip risky fixes
      4. Document everything
      5. Commit at the end

validations:
  - type: file_exists
    path: "{workspace}/01-issues.yaml"
    description: "Issues file must exist"
    condition: "sheet_num >= 1"

  - type: file_exists
    path: "{workspace}/02-quick-wins.md"
    description: "Quick wins report must exist"
    condition: "sheet_num >= 2"

  - type: file_exists
    path: "{workspace}/03-medium-fixes.md"
    description: "Medium fixes report must exist"
    condition: "sheet_num >= 3"

  - type: file_exists
    path: "{workspace}/04-significant-fixes.md"
    description: "Significant fixes report must exist"
    condition: "sheet_num >= 4"

  - type: file_exists
    path: "{workspace}/05-summary.md"
    description: "Summary must exist"
    condition: "sheet_num >= 5"

  - type: file_exists
    path: "{workspace}/06-commit.md"
    description: "Commit report must exist"
    condition: "sheet_num == 6"

  # Tests must pass before committing
  - type: command_succeeds
    command: "pytest -x -q --tb=no 2>&1 | tail -1 | grep -E 'passed|no tests'"
    description: "Tests must pass"
    condition: "sheet_num >= 5"

  # Verify commit was created (check git log for recent commit)
  - type: command_succeeds
    command: "git log --oneline -1 --since='5 minutes ago' | grep -E 'Quality iteration|refactor'"
    description: "Commit must be created"
    condition: "sheet_num == 6"

# Self-chain for continuous improvement
on_success:
  - type: run_job
    job_path: "examples/quality-continuous.yaml"
    description: "Chain to next quality iteration"
    detached: true

concert:
  enabled: true
  max_chain_depth: 10
  cooldown_between_jobs_seconds: 60
  inherit_workspace: false
