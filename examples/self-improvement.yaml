# Example: Self-Improvement Job
# Template for using Mozart to improve a codebase incrementally
#
# This pattern was used by Mozart to improve itself - each batch
# implements one task, with validations ensuring quality gates.
#
# Usage:
#   mozart run examples/self-improvement.yaml
#   mozart status self-improvement
#   mozart resume self-improvement

name: "self-improvement"
description: "Incremental codebase improvement with quality gates"

workspace: "./improvement-workspace"

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: /path/to/your/project  # CHANGE THIS
  timeout_seconds: 1800  # 30 minutes per task

batch:
  size: 1           # One task per batch (recommended for code changes)
  total_items: 4    # Number of tasks
  start_item: 1     # Resume from this item

retry:
  max_retries: 2
  base_delay_seconds: 30
  max_completion_attempts: 2

rate_limit:
  wait_minutes: 60
  max_waits: 3

# Quality gates - all must pass for batch to complete
validations:
  - type: command_succeeds
    command: "cd {{ project_root }} && pytest tests/ -q --tb=no 2>&1 | tail -1 | grep -E '^[0-9]+ passed'"
    description: "All tests must pass"

  - type: command_succeeds
    command: "cd {{ project_root }} && mypy src/ 2>&1 | grep -q 'Success'"
    description: "Type checking must pass"

  - type: command_succeeds
    command: "cd {{ project_root }} && ruff check src/ --quiet"
    description: "Linting must pass"

prompt:
  variables:
    project_root: /path/to/your/project  # CHANGE THIS

  template: |
    You are improving a codebase incrementally.

    Project: {{ project_root }}
    Task: {{ batch_num }} of {{ total_batches }}

    ## Context
    [Describe your project and what you're trying to achieve]

    Key files:
    - src/main.py
    - src/utils.py
    - tests/test_main.py

    ---

    {% if batch_num == 1 %}
    ## Task 1: [First improvement]

    [Detailed instructions for task 1]

    {% elif batch_num == 2 %}
    ## Task 2: [Second improvement]

    [Detailed instructions for task 2]

    {% elif batch_num == 3 %}
    ## Task 3: [Third improvement]

    [Detailed instructions for task 3]

    {% elif batch_num == 4 %}
    ## Task 4: [Final improvement]

    [Detailed instructions for task 4]

    {% endif %}

    ## Quality Requirements

    - All code must pass type checking (mypy)
    - All code must pass linting (ruff)
    - Write tests for new functionality
    - Maintain backwards compatibility

  stakes: |
    Quality is non-negotiable. Each task builds on the previous,
    so ensure all validations pass before the batch completes.

notifications:
  - type: desktop
    on_events: [job_complete, job_failed, batch_failed]

state_backend: json
pause_between_batches_seconds: 5
