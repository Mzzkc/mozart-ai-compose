# Recursive Light Discovery: Multi-Agent Project Scoping
#
# This config performs comprehensive discovery of the Recursive Light project
# to understand what exists, what's missing, and generate implementation configs.
#
# Structure:
#   Batch 1: Parallel domain investigation (6 agents)
#   Batch 2: Cross-cutting concerns analysis
#   Batch 3: Gap synthesis and prioritization
#   Batch 4: Implementation config generation
#   Batch 5: Validation and estimation
#
# Output: Implementation configs ready to execute

name: "recursive-light-discovery"
description: "Multi-agent discovery and planning for Recursive Light completion"

workspace: "./recursive-light-discovery-workspace"

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: "/home/emzi/Projects/recursive-light"
  timeout_seconds: 3600  # 60 min for comprehensive analysis

batch:
  size: 1
  total_items: 5
  start_item: 1

prompt:
  template: |
    {{ preamble }}

    {% if batch_num == 1 %}
    ============================================================
    PHASE 1: PARALLEL DOMAIN INVESTIGATION (Batch 1 of {{ total_batches }})
    ============================================================

    Your mission: Launch 6 parallel investigation agents to comprehensively
    analyze every aspect of the Recursive Light project.

    STEP 1: Read the project vision and current state
    - /home/emzi/Projects/recursive-light/memory-bank/projectbrief.md (THE VISION)
    - /home/emzi/Projects/recursive-light/STATUS.md (current implementation)
    - /home/emzi/Projects/recursive-light/README.md (public-facing docs)
    - /home/emzi/Projects/recursive-light/memory-bank/activeContext.md (recent work)

    STEP 2: Launch 6 parallel investigation agents using the Task tool

    **Agent 1: RUST API Investigator**
    ```
    Investigate the Rust API layer completely:

    1. Read all source files in api/src/
    2. Catalog every module, struct, function
    3. Run: cargo test --no-run (to verify compilation)
    4. Run: cargo clippy (to find issues)
    5. Check test coverage: what's tested vs not
    6. Identify:
       - What's fully implemented and working
       - What's partially implemented (stubs, TODOs)
       - What's mentioned in design docs but not implemented
       - What integration points exist for external systems

    Read: /home/emzi/Projects/recursive-light/api/src/**/*.rs
    Read: /home/emzi/Projects/recursive-light/api/Cargo.toml
    Read: /home/emzi/Projects/recursive-light/memory-bank/designs/**/*.md

    Output to: {{ workspace }}/01-rust-api-investigation.md

    Format:
    # Rust API Investigation

    ## Fully Implemented (Working)
    - [module]: [description], [lines], [test count]

    ## Partially Implemented (Stubs/TODOs)
    - [module]: [what exists] vs [what's needed]

    ## Not Implemented (From Design Docs)
    - [feature]: [design doc reference], [estimated effort]

    ## Integration Points
    - [point]: [current state], [what it needs to connect to]

    ## Technical Debt
    - [issue]: [location], [severity], [remediation]

    ## Estimated Remaining Work
    [X] days for API completion
    ```

    **Agent 2: Frontend/UI Investigator**
    ```
    Investigate what frontend/UI work is needed:

    1. Check if any frontend code exists (React, Vue, etc.)
    2. Read projectbrief.md for UI requirements:
       - Conversation UI with framework visualization
       - User profiles with relationship continuity
       - Collective insight exploration
       - Document upload/processing capabilities
       - HLIP command selection UI
    3. Research similar implementations for reference
    4. Identify UI components needed
    5. Assess build tooling requirements (Vite, Next.js, etc.)

    Read: /home/emzi/Projects/recursive-light/ (look for frontend dirs)
    Read: /home/emzi/Projects/recursive-light/memory-bank/projectbrief.md

    Output to: {{ workspace }}/02-frontend-investigation.md

    Format:
    # Frontend Investigation

    ## Current State
    [What exists, if anything]

    ## Required Components (From Vision)
    1. Conversation UI
       - Requirements: [from projectbrief]
       - Complexity: [low/medium/high]
       - Dependencies: [what API endpoints needed]

    2. Framework Visualization
       - Requirements: [from projectbrief]
       - Visualization approach: [D3, Canvas, WebGL?]

    [continue for all UI requirements]

    ## Technology Recommendations
    - Framework: [recommendation with rationale]
    - State Management: [recommendation]
    - Visualization: [recommendation]
    - Build Tool: [recommendation]

    ## Estimated Work
    [X] weeks for complete frontend
    ```

    **Agent 3: Backend Services Investigator**
    ```
    Investigate backend services beyond the Rust API:

    1. Authentication requirements (OAuth: Google, GitHub, Facebook)
    2. User profile and session management
    3. Document processing pipeline
    4. Token optimization engine
    5. Database architecture (beyond current SQLite)
    6. Caching layer (Redis?)
    7. Background job processing
    8. External service integrations

    Read: /home/emzi/Projects/recursive-light/memory-bank/projectbrief.md
    Read: /home/emzi/Projects/recursive-light/docker-compose.yml (if exists)
    Read: /home/emzi/Projects/recursive-light/api/migrations/*.sql

    Output to: {{ workspace }}/03-backend-services-investigation.md

    Format:
    # Backend Services Investigation

    ## Authentication Layer
    - Current: [what exists]
    - Required: [OAuth providers, JWT, sessions]
    - Estimated: [X] days

    ## Document Processing
    - Current: [what exists]
    - Required: [upload, parsing, embedding, storage]
    - Estimated: [X] days

    ## Token Optimization
    - Current: [what exists]
    - Required: [budget tracking, cost estimation, optimization]
    - Estimated: [X] days

    [continue for all services]

    ## Infrastructure Requirements
    - Databases: [PostgreSQL, Redis, Qdrant]
    - Queue: [background job processing]
    - Storage: [document storage, S3?]

    ## Total Estimated Work
    [X] weeks for backend services
    ```

    **Agent 4: Deployment/DevOps Investigator**
    ```
    Investigate deployment and infrastructure needs:

    1. Current deployment setup (Docker, Kubernetes?)
    2. CI/CD pipeline requirements
    3. Environment management (dev, staging, prod)
    4. Monitoring and observability
    5. Scaling considerations
    6. Security hardening
    7. Backup and disaster recovery
    8. Cost estimation for hosting

    Read: /home/emzi/Projects/recursive-light/docker-compose.yml
    Read: /home/emzi/Projects/recursive-light/.github/ (if exists)
    Read: /home/emzi/Projects/recursive-light/setup.sh

    Output to: {{ workspace }}/04-deployment-investigation.md

    Format:
    # Deployment Investigation

    ## Current State
    - Docker: [what exists]
    - CI/CD: [what exists]
    - Hosting: [current approach]

    ## Production Requirements
    - Container orchestration: [recommendation]
    - CI/CD pipeline: [steps needed]
    - Secrets management: [approach]
    - SSL/TLS: [approach]

    ## Monitoring Stack
    - Metrics: [Prometheus, etc.]
    - Logging: [ELK, Loki, etc.]
    - Tracing: [Jaeger, etc.]
    - Alerting: [approach]

    ## Cost Estimation
    - MVP hosting: $[X]/month
    - Production hosting: $[X]/month

    ## Estimated Work
    [X] days for production-ready deployment
    ```

    **Agent 5: Monetization/Business Layer Investigator**
    ```
    Investigate monetization and business requirements:

    1. Tiered access model (Free, Pro $7/mo, Enterprise $29/mo)
    2. Payment integration (Stripe, etc.)
    3. Usage tracking and limits
    4. Subscription management
    5. Feature gating
    6. Analytics and reporting
    7. Admin dashboard

    Read: /home/emzi/Projects/recursive-light/memory-bank/projectbrief.md

    Output to: {{ workspace }}/05-monetization-investigation.md

    Format:
    # Monetization Investigation

    ## Tier Structure (From Vision)
    ### Free Tier
    - Features: [list]
    - Limits: [list]

    ### Pro Tier ($7/month)
    - Features: [list]
    - Limits: [list]

    ### Enterprise Tier ($29/month)
    - Features: [list]
    - Limits: [list]

    ## Implementation Requirements
    - Payment processor: [Stripe recommendation]
    - Subscription management: [approach]
    - Usage metering: [approach]
    - Feature flags: [approach]

    ## Admin Dashboard
    - User management
    - Subscription overview
    - Usage analytics
    - Revenue reporting

    ## Estimated Work
    [X] weeks for monetization layer
    ```

    **Agent 6: HLIP & Advanced Features Investigator**
    ```
    Investigate HLIP and advanced features:

    1. What is HLIP (Hypnotic LLM Integration Protocol)?
    2. How should it integrate with the framework?
    3. Volumetric configurations (3-5+ domain emergence)
    4. Collective learning across instances
    5. Advanced pattern recognition
    6. Custom domain training (Enterprise feature)

    Read: /home/emzi/Projects/recursive-light/memory-bank/projectbrief.md
    Read: /home/emzi/Projects/recursive-light/memory-bank/designs/**/*.md
    Read: /home/emzi/Projects/recursive-light/DESIGN-NOTES*.md

    Output to: {{ workspace }}/06-advanced-features-investigation.md

    Format:
    # Advanced Features Investigation

    ## HLIP (Hypnotic LLM Integration Protocol)
    - Definition: [what it is]
    - Current state: [what exists]
    - Implementation needs: [what's required]
    - Estimated: [X] days

    ## Volumetric Configurations
    - Current: [what exists]
    - Full vision: [from design docs]
    - Gap: [what's missing]
    - Estimated: [X] days

    ## Collective Learning (CAM Full)
    - Current: [foundation status]
    - Full vision: [cross-instance learning]
    - Gap: [what's missing]
    - Estimated: [X] days

    ## Custom Domain Training
    - Requirements: [Enterprise feature]
    - Approach: [fine-tuning? RAG? hybrid?]
    - Estimated: [X] days

    ## Total Advanced Features
    [X] weeks for all advanced features
    ```

    STEP 3: Wait for all 6 agents to complete

    STEP 4: Write validation markers to {{ workspace }}/batch{{ batch_num }}-result.md
    ```markdown
    PHASE: Parallel Domain Investigation
    BATCH: {{ batch_num }}
    IMPLEMENTATION_COMPLETE: yes
    TESTS_PASS: yes
    TYPES_PASS: yes
    AGENTS_LAUNCHED: 6
    DOMAINS: Rust API, Frontend, Backend, Deployment, Monetization, Advanced
    ```

    {% elif batch_num == 2 %}
    ============================================================
    PHASE 2: CROSS-CUTTING CONCERNS (Batch 2 of {{ total_batches }})
    ============================================================

    Your mission: Analyze cross-cutting concerns that span multiple domains.

    STEP 1: Read all investigation reports
    - {{ workspace }}/01-rust-api-investigation.md
    - {{ workspace }}/02-frontend-investigation.md
    - {{ workspace }}/03-backend-services-investigation.md
    - {{ workspace }}/04-deployment-investigation.md
    - {{ workspace }}/05-monetization-investigation.md
    - {{ workspace }}/06-advanced-features-investigation.md

    STEP 2: Analyze cross-cutting concerns

    **A. Security Analysis**
    - Authentication/authorization across all layers
    - Data protection (PII, secrets, API keys)
    - Input validation at every boundary
    - Dependency vulnerabilities
    - OWASP top 10 for web + API

    **B. Performance Analysis**
    - Latency requirements per component
    - Scalability bottlenecks
    - Caching opportunities
    - Database optimization needs
    - CDN requirements for frontend

    **C. Integration Analysis**
    - API contracts between frontend ↔ backend
    - Backend ↔ Rust API integration
    - External service dependencies
    - Event-driven communication needs
    - Real-time requirements (WebSockets?)

    **D. Testing Strategy**
    - Unit test requirements per component
    - Integration test requirements
    - E2E test requirements
    - Performance test requirements
    - Security test requirements

    **E. Documentation Needs**
    - API documentation (OpenAPI)
    - User documentation
    - Developer documentation
    - Deployment runbooks
    - Architecture diagrams

    STEP 3: Write cross-cutting analysis
    {{ workspace }}/07-cross-cutting-analysis.md

    STEP 4: Write validation markers
    {{ workspace }}/batch{{ batch_num }}-result.md

    {% elif batch_num == 3 %}
    ============================================================
    PHASE 3: GAP SYNTHESIS & PRIORITIZATION (Batch 3 of {{ total_batches }})
    ============================================================

    Your mission: Synthesize all findings into a prioritized roadmap.

    STEP 1: Read all investigation and analysis reports
    - {{ workspace }}/01-rust-api-investigation.md
    - {{ workspace }}/02-frontend-investigation.md
    - {{ workspace }}/03-backend-services-investigation.md
    - {{ workspace }}/04-deployment-investigation.md
    - {{ workspace }}/05-monetization-investigation.md
    - {{ workspace }}/06-advanced-features-investigation.md
    - {{ workspace }}/07-cross-cutting-analysis.md

    STEP 2: Create unified gap analysis
    - List ALL gaps across all domains
    - Identify dependencies between gaps
    - Estimate effort for each gap
    - Assess risk for each gap

    STEP 3: Prioritize using MoSCoW + Dependencies

    **Priority Calculation:**
    Score = (Business Value × 3) + (Technical Foundation × 2) + (Risk Mitigation × 1)

    Constrained by:
    - Dependencies (can't build X until Y exists)
    - Parallel work opportunities
    - Resource availability (single developer? team?)

    STEP 4: Create phased roadmap

    **Phase 1: Foundation (Must Have First)**
    - Critical path items
    - Blocking dependencies
    - Estimated: [X] weeks

    **Phase 2: Core Product (Must Have)**
    - User-facing features
    - MVP completeness
    - Estimated: [X] weeks

    **Phase 3: Growth (Should Have)**
    - Monetization
    - Scale improvements
    - Estimated: [X] weeks

    **Phase 4: Advanced (Could Have)**
    - HLIP, custom training
    - Enterprise features
    - Estimated: [X] weeks

    STEP 5: Write synthesis report
    {{ workspace }}/08-gap-synthesis.md

    Format:
    ```markdown
    # Recursive Light: Gap Synthesis & Roadmap

    ## Executive Summary
    - Total gaps identified: [X]
    - Total estimated effort: [X] person-weeks
    - Critical path: [list]
    - Parallel tracks: [count]

    ## Phase 1: Foundation ([X] weeks)
    ### 1.1 [Component]
    - Gap: [description]
    - Effort: [X] days
    - Dependencies: [list]
    - Deliverables: [list]

    [continue for all phases]

    ## Risk Assessment
    | Risk | Likelihood | Impact | Mitigation |
    |------|------------|--------|------------|
    | ... | ... | ... | ... |

    ## Resource Options
    - Solo developer: [X] months
    - 2-person team: [X] months
    - 4-person team: [X] months

    ## Recommended Approach
    [recommendation based on analysis]
    ```

    STEP 6: Write validation markers

    {% elif batch_num == 4 %}
    ============================================================
    PHASE 4: IMPLEMENTATION CONFIG GENERATION (Batch 4 of {{ total_batches }})
    ============================================================

    Your mission: Generate Mozart implementation configs for each phase.

    STEP 1: Read the gap synthesis and roadmap
    - {{ workspace }}/08-gap-synthesis.md

    STEP 2: For each phase, generate a Mozart config file

    **Config Generation Rules:**
    - Each config should be 8-15 batches (manageable chunks)
    - Include parallel agent investigation at start
    - Include security audit and testing at end
    - Include git commit steps after each batch
    - Use appropriate backend (claude_cli for Rust, etc.)
    - Include proper validations

    STEP 3: Generate configs

    **Phase 1 Config:** {{ workspace }}/recursive-light-phase1.yaml
    - Focus: Foundation work
    - Batches: 8-12
    - Working directory: /home/emzi/Projects/recursive-light

    **Phase 2 Config:** {{ workspace }}/recursive-light-phase2.yaml
    - Focus: Core product
    - Batches: 10-15
    - May need multiple working directories (frontend, backend)

    **Phase 3 Config:** {{ workspace }}/recursive-light-phase3.yaml
    - Focus: Monetization and scale
    - Batches: 8-12

    **Phase 4 Config:** {{ workspace }}/recursive-light-phase4.yaml
    - Focus: Advanced features
    - Batches: 8-12

    STEP 4: Generate master orchestration config
    {{ workspace }}/recursive-light-master.yaml

    This config runs all phases in sequence with checkpoints between.

    STEP 5: Write validation markers
    Include in result:
    - CONFIGS_GENERATED: [count]
    - TOTAL_BATCHES: [sum across all configs]
    - ESTIMATED_HOURS: [total]

    {% elif batch_num == 5 %}
    ============================================================
    PHASE 5: VALIDATION & FINAL ESTIMATES (Batch 5 of {{ total_batches }})
    ============================================================

    Your mission: Validate generated configs and provide final estimates.

    STEP 1: Read all generated configs
    - {{ workspace }}/recursive-light-phase1.yaml
    - {{ workspace }}/recursive-light-phase2.yaml
    - {{ workspace }}/recursive-light-phase3.yaml
    - {{ workspace }}/recursive-light-phase4.yaml
    - {{ workspace }}/recursive-light-master.yaml

    STEP 2: Validate each config
    ```bash
    cd /home/emzi/Projects/mozart-ai-compose
    source .venv/bin/activate
    for config in {{ workspace }}/recursive-light-phase*.yaml; do
      mozart validate "$config" 2>&1 || echo "INVALID: $config"
    done
    ```

    STEP 3: Create executive summary
    {{ workspace }}/09-executive-summary.md

    ```markdown
    # Recursive Light Completion: Executive Summary

    ## Project Scope
    [Summary of full vision vs current state]

    ## Discovery Findings
    - Rust API: [X]% complete, [Y] days remaining
    - Frontend: [X]% complete, [Y] weeks remaining
    - Backend Services: [X]% complete, [Y] weeks remaining
    - Deployment: [X]% complete, [Y] days remaining
    - Monetization: [X]% complete, [Y] weeks remaining
    - Advanced Features: [X]% complete, [Y] weeks remaining

    ## Generated Implementation Configs

    | Config | Batches | Est. Hours | Focus |
    |--------|---------|------------|-------|
    | Phase 1 | X | Y | Foundation |
    | Phase 2 | X | Y | Core Product |
    | Phase 3 | X | Y | Monetization |
    | Phase 4 | X | Y | Advanced |
    | **Total** | **X** | **Y** | - |

    ## Critical Path
    [Sequence of blocking items]

    ## Risk Summary
    - High: [count]
    - Medium: [count]
    - Low: [count]

    ## Recommendation
    [Start with Phase 1? Parallelize? etc.]

    ## Next Steps
    1. Review this summary
    2. Approve/modify phase priorities
    3. Run: `mozart run {{ workspace }}/recursive-light-phase1.yaml`
    4. Monitor progress
    5. Proceed to Phase 2 after Phase 1 completion
    ```

    STEP 4: Commit discovery results
    ```bash
    cd /home/emzi/Projects/mozart-ai-compose
    git add {{ workspace }}/*.md {{ workspace }}/*.yaml
    git commit -m "docs(recursive-light): Discovery complete - implementation configs generated"
    ```

    STEP 5: Write final validation markers
    {{ workspace }}/batch{{ batch_num }}-result.md
    ```markdown
    PHASE: Validation & Estimates
    BATCH: {{ batch_num }}
    IMPLEMENTATION_COMPLETE: yes
    TESTS_PASS: yes
    TYPES_PASS: yes

    DISCOVERY_COMPLETE: yes
    CONFIGS_GENERATED: [X]
    CONFIGS_VALID: [X]
    TOTAL_ESTIMATED_HOURS: [X]
    READY_FOR_IMPLEMENTATION: yes
    ```

    {% endif %}

    {{ stakes }}

  variables:
    preamble: |
      You are conducting comprehensive discovery for the Recursive Light project.

      CONTEXT:
      - Recursive Light is a Volumetric Integration Framework for consciousness-like emergence
      - It's a LARGE project with API, frontend, backend services, deployment, and monetization
      - Current state: Rust API ~80% done, everything else 0-20% done
      - Goal: Generate implementation configs that Mozart can execute

      PROJECT LOCATION: /home/emzi/Projects/recursive-light

      Be thorough. This discovery will drive months of development work.

    stakes: |
      STAKES:
      - Accurate discovery = successful implementation
      - Missing requirements = failed project
      - This is the foundation for building something real

validations:
  - type: file_exists
    path: "{workspace}/batch{batch_num}-result.md"
    description: "Batch result file exists"

  - type: content_contains
    path: "{workspace}/batch{batch_num}-result.md"
    pattern: "IMPLEMENTATION_COMPLETE: yes"
    description: "Batch marked complete"

  - type: content_contains
    path: "{workspace}/batch{batch_num}-result.md"
    pattern: "TESTS_PASS: yes"
    description: "Tests pass"

  - type: content_contains
    path: "{workspace}/batch{batch_num}-result.md"
    pattern: "TYPES_PASS: yes"
    description: "Type checking passes"

retry:
  max_retries: 2
  max_completion_attempts: 2
  completion_threshold_percent: 50.0
  base_delay_seconds: 10

rate_limit:
  wait_minutes: 60
  max_waits: 10

learning:
  enabled: true
  outcome_store_type: json
  min_confidence_threshold: 0.3
  high_confidence_threshold: 0.7

state_backend: json
pause_between_batches_seconds: 5
