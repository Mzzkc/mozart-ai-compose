# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║                    MOZART QUALITY SCORE: 50 ITEMS                           ║
# ║                                                                              ║
# ║  Comprehensive code quality improvement across 10 categories                 ║
# ║  Uses cross-sheet context to build on previous discoveries                   ║
# ║                                                                              ║
# ║  Structure:                                                                  ║
# ║    Sheets 1-5:  Discovery (50 issues across 10 categories)                   ║
# ║    Sheet 6:     Prioritization and planning                                  ║
# ║    Sheets 7-10: Implementation (batched fixes)                               ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: "mozart-quality-50"
description: "Comprehensive code quality improvement - 50 items across 10 categories"

workspace: "/home/emzi/Projects/mozart-ai-compose/quality-workspace"

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: "/home/emzi/Projects/mozart-ai-compose"
  timeout_seconds: 3600

# Cross-sheet context for building on previous discoveries
cross_sheet:
  auto_capture_stdout: true
  max_output_chars: 3000
  lookback_sheets: 2
  capture_files:
    - "{{ workspace }}/discovery-*.md"
    - "{{ workspace }}/fix-plan.md"

sheet:
  size: 1
  total_items: 10
  start_item: 1

retry:
  max_retries: 2
  max_completion_attempts: 2

prompt:
  template: |
    {{ preamble }}

    {% if sheet_num == 1 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY DISCOVERY - BATCH 1/5: Dead Code & Complexity                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    Analyze the Mozart codebase for quality issues. Find 10 specific issues:

    **Category 1: Dead Code (5 items)**
    - Unused imports
    - Unreachable code branches
    - Unused variables or functions
    - Orphan helper functions
    - Commented-out code blocks

    **Category 2: Complexity (5 items)**
    - Functions > 50 LOC
    - Deep nesting (> 4 levels)
    - High cyclomatic complexity (> 10)
    - Long method chains
    - Complex conditionals

    **Search these key files:**
    - src/mozart/cli.py (6180 LOC)
    - src/mozart/execution/runner.py (4496 LOC)
    - src/mozart/learning/global_store.py (5136 LOC)
    - src/mozart/core/errors.py (2388 LOC)

    **For each issue document:**
    ```yaml
    - id: Q001
      category: dead_code | complexity
      file: path/to/file.py
      line: N
      severity: critical | high | medium | low
      description: |
        Brief description of the issue
      current_code: |
        The problematic code snippet (5-10 lines)
      suggested_fix: |
        How to fix it
      effort: quick | medium | significant
    ```

    Write findings to {{ workspace }}/discovery-batch-1.md

    {% elif sheet_num == 2 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY DISCOVERY - BATCH 2/5: Naming & Error Handling                      ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Discovery Summary
    {{ previous_outputs[1][:1000] if 1 in previous_outputs else "" }}
    {% endif %}

    Find 10 more issues:

    **Category 3: Naming (5 items)**
    - Unclear/ambiguous names
    - Inconsistent conventions (snake_case vs camelCase)
    - Single-letter variables outside loops
    - Abbreviations without context
    - Misleading names

    **Category 4: Error Handling (5 items)**
    - Bare except clauses
    - Swallowed exceptions (catch and ignore)
    - Missing error context
    - Generic error messages
    - Exceptions in wrong layer

    Use the same YAML format from Sheet 1.
    Continue numbering from Q011.

    Write to {{ workspace }}/discovery-batch-2.md

    {% elif sheet_num == 3 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY DISCOVERY - BATCH 3/5: Type Safety & Duplication                    ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Discovery Summary
    {{ previous_outputs[2][:1000] if 2 in previous_outputs else "" }}
    {% endif %}

    Find 10 more issues:

    **Category 5: Type Safety (5 items)**
    - Missing type hints on public APIs
    - Overuse of `Any` type
    - `# type: ignore` comments
    - Optional vs None confusion
    - Incorrect return type hints

    **Category 6: Duplication (5 items)**
    - Copy-paste code blocks
    - Similar logic in multiple places
    - Repeated validation patterns
    - Duplicate error handling
    - Near-identical functions

    Continue numbering from Q021.

    Write to {{ workspace }}/discovery-batch-3.md

    {% elif sheet_num == 4 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY DISCOVERY - BATCH 4/5: Documentation & Testing                      ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Discovery Summary
    {{ previous_outputs[3][:1000] if 3 in previous_outputs else "" }}
    {% endif %}

    Find 10 more issues:

    **Category 7: Documentation (5 items)**
    - Missing docstrings on public APIs
    - Outdated comments
    - Unclear parameter descriptions
    - Missing return value docs
    - Misleading comments

    **Category 8: Testing (5 items)**
    - Untested edge cases
    - Missing error path tests
    - Brittle tests (implementation-dependent)
    - Tests without assertions
    - Skipped tests without reason

    Continue numbering from Q031.

    Write to {{ workspace }}/discovery-batch-4.md

    {% elif sheet_num == 5 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY DISCOVERY - BATCH 5/5: Performance & Security                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Discovery Summary
    {{ previous_outputs[4][:1000] if 4 in previous_outputs else "" }}
    {% endif %}

    Find final 10 issues:

    **Category 9: Performance (5 items)**
    - O(n^2) loops where O(n) possible
    - Repeated computations in loops
    - Unnecessary allocations
    - Blocking calls in async code
    - Missing caching opportunities

    **Category 10: Security (5 items)**
    - Path injection vulnerabilities
    - Unsafe defaults
    - Hardcoded values that should be config
    - Missing input validation
    - Sensitive data in logs

    Continue numbering from Q041.

    Write to {{ workspace }}/discovery-batch-5.md

    {% elif sheet_num == 6 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY PRIORITIZATION: Create Fix Plan                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    Read all discovery files and create a prioritized fix plan.

    **Files to read:**
    - {{ workspace }}/discovery-batch-1.md
    - {{ workspace }}/discovery-batch-2.md
    - {{ workspace }}/discovery-batch-3.md
    - {{ workspace }}/discovery-batch-4.md
    - {{ workspace }}/discovery-batch-5.md

    **Create prioritized plan:**

    1. Group by effort (quick-fix, medium, significant)
    2. Within each group, order by severity (critical > high > medium > low)
    3. Identify dependencies between fixes
    4. Create 4 implementation batches (for sheets 7-10)

    **Output format:**
    ```markdown
    # Mozart Quality Fix Plan

    ## Summary
    - Total issues: 50
    - Quick fixes: N
    - Medium effort: N
    - Significant effort: N

    ## Batch 1 (Sheet 7): Quick Wins
    [List of ~12 items - all quick fixes]

    ## Batch 2 (Sheet 8): Naming & Types
    [List of ~12 items]

    ## Batch 3 (Sheet 9): Error Handling & Documentation
    [List of ~12 items]

    ## Batch 4 (Sheet 10): Complex Refactors
    [List of ~14 items - significant effort]

    ## Dependencies
    [Any fixes that must happen before others]
    ```

    Write to {{ workspace }}/fix-plan.md

    {% elif sheet_num == 7 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY FIXES - BATCH 1: Quick Wins                                         ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:2000] }}
    {% endif %}
    {% endfor %}

    Implement Batch 1 fixes from the plan.

    **For each fix:**
    1. Read the current code
    2. Apply the fix
    3. Verify the change (run relevant tests if applicable)
    4. Document what was changed

    **Output format:**
    ```markdown
    ## Fix Results - Batch 1

    ### Q001: [Description]
    - File: path/to/file.py
    - Status: FIXED | SKIPPED (reason)
    - Change: Brief description

    [repeat for each fix in batch]

    ## Summary
    - Fixed: N
    - Skipped: N
    - Tests passed: yes/no
    ```

    Write to {{ workspace }}/fixes-batch-1.md

    {% elif sheet_num == 8 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY FIXES - BATCH 2: Naming & Types                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Batch Results
    {{ previous_outputs[7][:1000] if 7 in previous_outputs else "" }}
    {% endif %}

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:2000] }}
    {% endif %}
    {% endfor %}

    Implement Batch 2 fixes from the plan (Naming & Types).

    Follow the same process and output format as Batch 1.

    Write to {{ workspace }}/fixes-batch-2.md

    {% elif sheet_num == 9 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY FIXES - BATCH 3: Error Handling & Documentation                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Batch Results
    {{ previous_outputs[8][:1000] if 8 in previous_outputs else "" }}
    {% endif %}

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:2000] }}
    {% endif %}
    {% endfor %}

    Implement Batch 3 fixes from the plan (Error Handling & Documentation).

    Follow the same process and output format as Batch 1.

    Write to {{ workspace }}/fixes-batch-3.md

    {% elif sheet_num == 10 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  QUALITY FIXES - BATCH 4: Complex Refactors + Summary                        ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Previous Batch Results
    {{ previous_outputs[9][:1000] if 9 in previous_outputs else "" }}
    {% endif %}

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:2000] }}
    {% endif %}
    {% endfor %}

    **Part 1: Implement Batch 4 fixes** (Complex Refactors)

    **Part 2: Create final summary**

    ```markdown
    # Mozart Quality Improvement Summary

    ## Statistics
    - Total issues found: 50
    - Issues fixed: N
    - Issues skipped: N (with reasons)

    ## By Category
    | Category | Found | Fixed | Skipped |
    |----------|-------|-------|---------|
    | Dead Code | 5 | N | N |
    | Complexity | 5 | N | N |
    | ... | ... | ... | ... |

    ## Key Improvements
    1. [Most impactful fix]
    2. [Second most impactful]
    3. [Third most impactful]

    ## Recommendations for Future
    - [Issues that need architectural changes]
    - [Patterns to watch for going forward]

    ## Test Results
    - pytest: [pass/fail count]
    - mypy: [issues if any]
    ```

    Write fixes to {{ workspace }}/fixes-batch-4.md
    Write summary to {{ workspace }}/quality-summary.md

    {% endif %}

  variables:
    preamble: |
      ╔══════════════════════════════════════════════════════════════════════════╗
      ║                    MOZART QUALITY IMPROVEMENT SCORE                      ║
      ║                          50 Items / 10 Categories                        ║
      ╚══════════════════════════════════════════════════════════════════════════╝

      You are executing a comprehensive code quality improvement score.

      **Target Codebase:** Mozart AI Compose
      **Goal:** Find and fix 50 code quality issues

      **Categories (5 items each):**
      1. Dead Code - unused imports, unreachable code
      2. Complexity - long functions, deep nesting
      3. Naming - unclear names, inconsistent conventions
      4. Error Handling - bare excepts, swallowed errors
      5. Type Safety - missing hints, Any abuse
      6. Duplication - copy-paste, repeated patterns
      7. Documentation - missing docstrings, stale comments
      8. Testing - untested paths, brittle tests
      9. Performance - O(n^2), unnecessary allocations
      10. Security - path injection, unsafe defaults

      **Quality Principles:**
      - Fix real issues, not style preferences
      - Preserve functionality - all tests must pass
      - Document each change clearly
      - Prioritize by impact, not ease

validations:
  - type: file_exists
    path: "{{ workspace }}/discovery-batch-{{ sheet_num }}.md"
    description: "Discovery batch {{ sheet_num }} must exist"
    condition: "sheet_num <= 5"

  - type: file_exists
    path: "{{ workspace }}/fix-plan.md"
    description: "Fix plan must exist"
    condition: "sheet_num == 6"

  - type: file_exists
    path: "{{ workspace }}/fixes-batch-{{ sheet_num - 6 }}.md"
    description: "Fixes batch {{ sheet_num - 6 }} must exist"
    condition: "sheet_num >= 7 and sheet_num <= 10"

  - type: file_exists
    path: "{{ workspace }}/quality-summary.md"
    description: "Quality summary must exist"
    condition: "sheet_num == 10"
