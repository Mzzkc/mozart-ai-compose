# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║              MOZART QUALITY REVIEW: SYNTHESIZED                              ║
# ║                                                                              ║
# ║  Combines TDF expert perspectives with structured category discovery         ║
# ║                                                                              ║
# ║  Structure:                                                                  ║
# ║    Movement I  (Sheets 1-3): Expert Reviews (Architecture, Testing, Debt)   ║
# ║    Movement II (Sheet 4):    Category Discovery (10 categories, 30 items)   ║
# ║    Movement III (Sheet 5):   Synthesis & Prioritization                     ║
# ║    Movement IV (Sheets 6-8): Remediation Batches                            ║
# ║    Movement V  (Sheet 9):    Verification & Summary                         ║
# ║                                                                              ║
# ║  Post-modularization aware: Targets new store/, runner/, cli/ packages      ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: "quality-review-synthesized"
description: "Expert perspectives + structured categories for comprehensive quality review"

workspace: "/home/emzi/Projects/mozart-ai-compose/quality-review-workspace"

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: "/home/emzi/Projects/mozart-ai-compose"
  timeout_seconds: 3600

cross_sheet:
  auto_capture_stdout: true
  max_output_chars: 3000
  lookback_sheets: 2
  capture_files:
    - "{{ workspace }}/*.md"

sheet:
  size: 1
  total_items: 9
  start_item: 1

retry:
  max_retries: 2
  max_completion_attempts: 2

prompt:
  template: |
    {{ preamble }}

    {% if sheet_num == 1 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT I-A: ARCHITECTURE REVIEW                                           ║
    ║  "Structure reveals intent; misalignment reveals debt"                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    You are the **Architecture Analyst**. Focus on structural integrity after
    the recent modularization (D2-D4 split cli.py, runner.py, global_store.py).

    **Target Modules (recently modularized):**
    ```
    src/mozart/learning/store/     # D2: 8 mixins from global_store.py
    src/mozart/execution/runner/   # D3: 8 modules from runner.py
    src/mozart/cli/                # D4: command modules (if complete)
    ```

    **Investigation Protocol:**

    1. **Module Cohesion Check**
       - Do mixins/modules have single responsibilities?
       - Are there methods that belong elsewhere?
       - Check for "feature envy" (methods using other module's data)

    2. **Import Graph Analysis**
       ```bash
       # Check for circular imports
       python -c "from mozart.learning.store import GlobalLearningStore; print('store OK')"
       python -c "from mozart.execution.runner import JobRunner; print('runner OK')"

       # Check cross-module dependencies
       grep -r "from mozart\." src/mozart/learning/store/*.py | head -20
       grep -r "from mozart\." src/mozart/execution/runner/*.py | head -20
       ```

    3. **Interface Consistency**
       - Are public APIs clearly defined in __init__.py?
       - Do re-export shims work correctly?

    **Output to:** {{ workspace }}/01-architecture-review.md

    Format:
    ```markdown
    # Architecture Review

    ## Module Cohesion Assessment
    | Module | Cohesion Score | Issues |
    |--------|---------------|--------|

    ## Import Graph Issues
    [Circular dependencies, tight coupling]

    ## Interface Problems
    [Public API issues, missing exports]

    ## Top 5 Structural Issues
    1. [Most critical]
    ...
    ```

    {% elif sheet_num == 2 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT I-B: TEST COVERAGE REVIEW                                          ║
    ║  "Untested code is unverified code"                                          ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    You are the **Test Coverage Analyst**. Focus on testing gaps, especially
    for the newly modularized code.

    **Investigation Protocol:**

    1. **Coverage Measurement**
       ```bash
       # Quick test run to verify nothing broke
       pytest tests/test_global_learning.py tests/test_runner.py -x -q --tb=no 2>&1 | tail -5

       # Count test files vs source modules
       echo "Store modules: $(ls src/mozart/learning/store/*.py 2>/dev/null | wc -l)"
       echo "Runner modules: $(ls src/mozart/execution/runner/*.py 2>/dev/null | wc -l)"
       echo "Test files: $(ls tests/test_*.py | wc -l)"
       ```

    2. **Module-Level Coverage**
       - Which new modules lack dedicated tests?
       - Are mixin methods tested individually?

    3. **Critical Path Tests**
       - Is JobRunner.run() thoroughly tested?
       - Are error recovery paths tested?
       - Are pattern operations tested?

    **Output to:** {{ workspace }}/02-test-coverage-review.md

    Format:
    ```markdown
    # Test Coverage Review

    ## Current State
    - Test count: [N]
    - Tests passing: [yes/no]

    ## Untested Modules
    | Module | Risk Level | Recommended Tests |
    |--------|------------|-------------------|

    ## Missing Test Scenarios
    1. [Critical untested path]
    ...

    ## Top 5 Testing Gaps
    1. [Most critical gap]
    ...
    ```

    {% elif sheet_num == 3 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT I-C: CODE DEBT REVIEW                                              ║
    ║  "Technical debt compounds; pay it down regularly"                           ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    You are the **Code Debt Analyst**. Hunt for accumulated debt:
    dead code, TODOs, hacks, temporary fixes that became permanent.

    **Investigation Protocol:**

    1. **Dead Code Detection**
       ```bash
       # Find legacy files that should be removed
       ls -la src/mozart/*_legacy.py src/mozart/**/*_legacy.py 2>/dev/null

       # Find unused imports (sample check)
       head -50 src/mozart/learning/store/patterns.py | grep "^from\|^import"
       ```

    2. **TODO/FIXME/HACK Scan**
       ```bash
       grep -rn "TODO\|FIXME\|HACK\|XXX\|TEMPORARY" src/mozart/ --include="*.py" | head -30
       ```

    3. **Commented Code**
       ```bash
       # Find large commented blocks
       grep -rn "^#.*def \|^#.*class " src/mozart/ --include="*.py" | head -20
       ```

    4. **Type Hint Gaps**
       ```bash
       # Find functions without return type hints
       grep -rn "def .*):$" src/mozart/learning/store/*.py | head -20
       ```

    **Output to:** {{ workspace }}/03-code-debt-review.md

    Format:
    ```markdown
    # Code Debt Review

    ## Legacy Files to Remove
    | File | Lines | Safe to Delete? |
    |------|-------|-----------------|

    ## TODOs/FIXMEs (by priority)
    | Location | Content | Age | Priority |
    |----------|---------|-----|----------|

    ## Commented Code Blocks
    [List of suspicious commented code]

    ## Type Hint Gaps
    [Functions missing type hints]

    ## Top 5 Debt Items
    1. [Highest priority debt]
    ...
    ```

    {% elif sheet_num == 4 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT II: CATEGORY DISCOVERY (30 Items)                                  ║
    ║  "Systematic discovery reveals patterns invisible to intuition"              ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Expert Reviews Summary
    {{ previous_outputs[1][:500] if 1 in previous_outputs else "" }}
    {{ previous_outputs[2][:500] if 2 in previous_outputs else "" }}
    {{ previous_outputs[3][:500] if 3 in previous_outputs else "" }}
    {% endif %}

    Find **30 specific issues** across 10 categories (3 per category):

    **Categories:**
    1. **Dead Code** - unused imports, unreachable branches, orphan functions
    2. **Complexity** - functions >50 LOC, deep nesting, complex conditionals
    3. **Naming** - unclear names, inconsistent conventions
    4. **Error Handling** - bare excepts, swallowed errors, missing context
    5. **Type Safety** - missing hints, Any abuse, type: ignore
    6. **Duplication** - copy-paste code, repeated patterns
    7. **Documentation** - missing docstrings, stale comments
    8. **Testing** - untested paths, brittle tests
    9. **Performance** - O(n²) loops, repeated computations
    10. **Security** - path injection, unsafe defaults

    **Focus on these files:**
    - src/mozart/learning/store/*.py (recently modularized)
    - src/mozart/execution/runner/*.py (recently modularized)
    - src/mozart/core/errors.py
    - src/mozart/execution/validation.py

    **Output to:** {{ workspace }}/04-category-discovery.md

    Format per issue:
    ```yaml
    - id: Q001
      category: [category]
      file: path/to/file.py
      line: N
      severity: critical | high | medium | low
      description: Brief description
      current_code: |
        [5-10 line snippet]
      suggested_fix: How to fix
      effort: quick | medium | significant
    ```

    {% elif sheet_num == 5 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT III: SYNTHESIS & PRIORITIZATION                                    ║
    ║  "Wisdom is knowing which fires to fight first"                              ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    Read all review files and create a prioritized remediation plan.

    **Files to synthesize:**
    - {{ workspace }}/01-architecture-review.md
    - {{ workspace }}/02-test-coverage-review.md
    - {{ workspace }}/03-code-debt-review.md
    - {{ workspace }}/04-category-discovery.md

    **Create prioritized plan:**

    1. **Deduplicate** - Remove issues found by multiple reviewers
    2. **Score** - severity × impact × ease of fix
    3. **Batch** - Group into 3 remediation batches:
       - Batch 1 (Sheet 6): Quick wins (< 10 min each, high impact)
       - Batch 2 (Sheet 7): Medium effort (structural fixes)
       - Batch 3 (Sheet 8): Significant (refactoring, new tests)

    **Output to:** {{ workspace }}/05-fix-plan.md

    Format:
    ```markdown
    # Quality Remediation Plan

    ## Summary
    - Total unique issues: N
    - From architecture review: N
    - From test review: N
    - From debt review: N
    - From category discovery: N

    ## Batch 1: Quick Wins (Sheet 6)
    [10-12 items, all quick fixes]

    ## Batch 2: Medium Effort (Sheet 7)
    [10-12 items]

    ## Batch 3: Significant (Sheet 8)
    [remaining items]

    ## Dependencies
    [Issues that must be fixed in order]

    ## Deferred (out of scope)
    [Issues too risky or large for this pass]
    ```

    {% elif sheet_num == 6 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT IV-A: QUICK WINS REMEDIATION                                       ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:3000] }}
    {% endif %}
    {% endfor %}

    Implement **Batch 1** fixes (quick wins).

    **For each fix:**
    1. Read the file
    2. Apply the fix
    3. Verify it works (import check or quick test)
    4. Document what changed

    **IMPORTANT:**
    - Do NOT break existing functionality
    - Run `pytest tests/test_global_learning.py -x -q --tb=no` periodically
    - If unsure, skip and document why

    **Output to:** {{ workspace }}/06-fixes-batch-1.md

    Format:
    ```markdown
    ## Batch 1 Results

    ### [Issue ID]: [Description]
    - File: path/to/file.py
    - Status: FIXED | SKIPPED (reason)
    - Change: What was changed

    [repeat for each]

    ## Summary
    - Fixed: N
    - Skipped: N
    - Tests: [pass/fail after batch]
    ```

    {% elif sheet_num == 7 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT IV-B: MEDIUM EFFORT REMEDIATION                                    ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Batch 1 Results
    {{ previous_outputs[6][:1000] if 6 in previous_outputs else "" }}
    {% endif %}

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:3000] }}
    {% endif %}
    {% endfor %}

    Implement **Batch 2** fixes (medium effort).

    Same process as Batch 1. These may involve:
    - Renaming across multiple files
    - Adding type hints to APIs
    - Improving error messages
    - Small refactors

    **Output to:** {{ workspace }}/07-fixes-batch-2.md

    {% elif sheet_num == 8 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT IV-C: SIGNIFICANT REMEDIATION                                      ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    ## Batch 2 Results
    {{ previous_outputs[7][:1000] if 7 in previous_outputs else "" }}
    {% endif %}

    {% for path, content in previous_files.items() %}
    {% if 'fix-plan' in path %}
    ## Fix Plan
    {{ content[:3000] }}
    {% endif %}
    {% endfor %}

    Implement **Batch 3** fixes (significant effort).

    These may involve:
    - Adding new tests
    - Restructuring code
    - Fixing complex issues

    **Be conservative.** If a fix seems risky, skip it and document why.

    **Output to:** {{ workspace }}/08-fixes-batch-3.md

    {% elif sheet_num == 9 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  MOVEMENT V: VERIFICATION & SUMMARY                                          ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Final Verification:**

    ```bash
    # 1. All tests pass
    pytest tests/ -x -q --tb=short 2>&1 | tail -20

    # 2. Type check (informational)
    mypy src/mozart/learning/store/ --ignore-missing-imports 2>&1 | tail -10

    # 3. Import verification
    python -c "from mozart.learning.store import GlobalLearningStore; print('store OK')"
    python -c "from mozart.execution.runner import JobRunner; print('runner OK')"
    python -c "import mozart.cli; print('cli OK')"
    ```

    **Output to:** {{ workspace }}/09-quality-summary.md

    Format:
    ```markdown
    # Mozart Quality Review Summary

    ## Final Test Results
    - pytest: [X passed, Y failed]
    - mypy: [issues if any]
    - imports: [all OK / issues]

    ## Statistics
    | Metric | Value |
    |--------|-------|
    | Total issues found | N |
    | Issues fixed | N |
    | Issues skipped | N |
    | Issues deferred | N |

    ## By Category
    | Category | Found | Fixed | Skipped |
    |----------|-------|-------|---------|
    | Dead Code | N | N | N |
    | ... | | | |

    ## Key Improvements Made
    1. [Most impactful fix]
    2. [Second most impactful]
    3. [Third]

    ## Remaining Technical Debt
    [Items deferred for future]

    ## Recommendations
    [Patterns to watch, processes to add]
    ```

    {% endif %}

  variables:
    preamble: |
      ╔══════════════════════════════════════════════════════════════════════════╗
      ║              MOZART QUALITY REVIEW: SYNTHESIZED                          ║
      ║         Expert Perspectives + Structured Category Discovery              ║
      ╚══════════════════════════════════════════════════════════════════════════╝

      **Context:** Mozart has recently undergone major modularization (D2-D4):
      - global_store.py (5136 LOC) → store/ package (8 mixins)
      - runner.py (4615 LOC) → runner/ package (8 modules)
      - cli.py (6180 LOC) → cli/ package (command modules)

      **Goal:** Identify and fix quality issues introduced or revealed by modularization.

      **Quality Principles:**
      - Fix real issues, not style preferences
      - Preserve functionality - tests must pass
      - Document each change clearly
      - Be conservative - skip risky fixes

validations:
  # Movement I: Expert reviews
  - type: file_exists
    path: "{workspace}/01-architecture-review.md"
    description: "Architecture review must exist"
    condition: "sheet_num >= 1"

  - type: file_exists
    path: "{workspace}/02-test-coverage-review.md"
    description: "Test coverage review must exist"
    condition: "sheet_num >= 2"

  - type: file_exists
    path: "{workspace}/03-code-debt-review.md"
    description: "Code debt review must exist"
    condition: "sheet_num >= 3"

  # Movement II: Category discovery
  - type: file_exists
    path: "{workspace}/04-category-discovery.md"
    description: "Category discovery must exist"
    condition: "sheet_num >= 4"

  # Movement III: Fix plan
  - type: file_exists
    path: "{workspace}/05-fix-plan.md"
    description: "Fix plan must exist"
    condition: "sheet_num >= 5"

  # Movement IV: Remediation batches
  - type: file_exists
    path: "{workspace}/06-fixes-batch-1.md"
    description: "Batch 1 fixes must exist"
    condition: "sheet_num >= 6"

  - type: file_exists
    path: "{workspace}/07-fixes-batch-2.md"
    description: "Batch 2 fixes must exist"
    condition: "sheet_num >= 7"

  - type: file_exists
    path: "{workspace}/08-fixes-batch-3.md"
    description: "Batch 3 fixes must exist"
    condition: "sheet_num >= 8"

  # Movement V: Final verification
  - type: file_exists
    path: "{workspace}/09-quality-summary.md"
    description: "Quality summary must exist"
    condition: "sheet_num == 9"

  # Tests must still pass after all changes
  - type: command_succeeds
    command: "pytest tests/test_global_learning.py tests/test_runner.py -x -q --tb=no 2>&1 | tail -1 | grep -E 'passed'"
    description: "Core tests must pass after remediation"
    condition: "sheet_num == 9"

# Can be chained after D4 modularization
# on_success:
#   - type: notification
#     message: "Quality review complete"
