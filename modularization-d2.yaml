# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║                    PHASE D2: MODULARIZE global_store.py                      ║
# ║                                                                              ║
# ║  Split src/mozart/learning/global_store.py (5136 LOC) using mixin pattern   ║
# ║  Chained from D1, chains to D3                                               ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: "modularization-d2-global-store"
description: "Split global_store.py into mixins with backward compatibility"

workspace: "/home/emzi/Projects/mozart-ai-compose/modularization-workspace-d2"

backend:
  type: claude_cli
  skip_permissions: true
  working_directory: "/home/emzi/Projects/mozart-ai-compose"
  timeout_seconds: 5400

cross_sheet:
  auto_capture_stdout: true
  max_output_chars: 2000
  lookback_sheets: 1

sheet:
  size: 1
  total_items: 9
  start_item: 1

retry:
  max_retries: 2

prompt:
  template: |
    {{ preamble }}

    {% if sheet_num == 1 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 1: ANALYZE global_store.py STRUCTURE                                  ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    **Task:** Analyze GlobalLearningStore class and plan the mixin split

    1. Read `src/mozart/learning/global_store.py`
    2. List all methods grouped by functionality:
       - Pattern CRUD methods
       - Execution recording methods
       - Rate limit methods
       - Drift detection methods
       - Escalation methods
       - Budget/entropy methods (v23)
    3. Count methods per group
    4. Identify shared state/dependencies between groups

    **Output format:**
    ```yaml
    analysis:
      total_methods: N
      total_loc: 5136
      groups:
        models:
          methods: [list]
          estimated_loc: N
        base:
          methods: [list]
          estimated_loc: N
        patterns:
          methods: [list]
          estimated_loc: N
        # ... etc
      shared_state:
        - _conn
        - _logger
        # etc
    ```

    Write to {{ workspace }}/sheet1-analysis.md

    {% elif sheet_num == 2 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 2: CREATE models.py - Dataclasses                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[1][:800] if 1 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract all dataclasses from global_store.py

    Create `src/mozart/learning/store_staging/models.py` with:
    - All `@dataclass` classes (approximately 14)
    - PatternRecord, ExecutionOutcome, RateLimitInfo, etc.
    - Keep all fields, docstrings, and type hints

    Write progress to {{ workspace }}/sheet2-models.md

    {% elif sheet_num == 3 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 3: CREATE base.py - Core Connection and Schema                        ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[2][:500] if 2 in previous_outputs else "" }}
    {% endif %}

    **Task:** Create base class with connection management

    Create `src/mozart/learning/store_staging/base.py` with:
    - `GlobalLearningStoreBase` class
    - `__init__`, `close`, connection methods
    - Schema creation methods
    - Migration methods
    - Shared state (_conn, _logger, _db_path)

    Write progress to {{ workspace }}/sheet3-base.md

    {% elif sheet_num == 4 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 4: CREATE patterns.py - Pattern Mixin                                 ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[3][:500] if 3 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract pattern-related methods

    Create `src/mozart/learning/store_staging/patterns.py` with `PatternMixin`:
    - record_pattern, get_pattern, update_pattern
    - get_patterns_for_context, query_patterns
    - calculate_trust_score, recalculate_all_trust_scores
    - quarantine_pattern, validate_pattern
    - Pattern effectiveness methods

    Write progress to {{ workspace }}/sheet4-patterns.md

    {% elif sheet_num == 5 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 5: CREATE executions.py - Execution Mixin                             ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[4][:500] if 4 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract execution recording methods

    Create `src/mozart/learning/store_staging/executions.py` with `ExecutionMixin`:
    - record_execution_outcome
    - get_execution_stats
    - get_similar_executions
    - Clustering methods

    Write progress to {{ workspace }}/sheet5-executions.md

    {% elif sheet_num == 6 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 6: CREATE rate_limits.py + drift.py                                   ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[5][:500] if 5 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract rate limit and drift methods

    Create `src/mozart/learning/store_staging/rate_limits.py` with `RateLimitMixin`:
    - record_rate_limit, get_rate_limit_info
    - check_rate_limit_active

    Create `src/mozart/learning/store_staging/drift.py` with `DriftMixin`:
    - detect_goal_drift, get_drift_history
    - retire_drifting_patterns, auto_retirement methods

    Write progress to {{ workspace }}/sheet6-ratelimits-drift.md

    {% elif sheet_num == 7 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 7: CREATE escalation.py + budget.py                                   ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[6][:500] if 6 in previous_outputs else "" }}
    {% endif %}

    **Task:** Extract escalation and budget methods

    Create `src/mozart/learning/store_staging/escalation.py` with `EscalationMixin`:
    - record_escalation_outcome
    - get_escalation_stats

    Create `src/mozart/learning/store_staging/budget.py` with `BudgetMixin`:
    - get_exploration_budget, record_exploration_outcome
    - check_entropy_response_needed, record_entropy_response
    - adjust_exploration_budget (v23 evolution)

    Write progress to {{ workspace }}/sheet7-escalation-budget.md

    {% elif sheet_num == 8 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 8: CREATE __init__.py IN STAGING                                      ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[7][:500] if 7 in previous_outputs else "" }}
    {% endif %}

    **Task:** Create the composed GlobalLearningStore in STAGING directory

    Create `src/mozart/learning/store_staging/__init__.py`:
    ```python
    """Global learning store with modular mixins."""
    from mozart.learning.store_staging.models import (
        PatternRecord, ExecutionOutcome, ...
    )
    from mozart.learning.store_staging.base import GlobalLearningStoreBase
    from mozart.learning.store_staging.patterns import PatternMixin
    from mozart.learning.store_staging.executions import ExecutionMixin
    from mozart.learning.store_staging.rate_limits import RateLimitMixin
    from mozart.learning.store_staging.drift import DriftMixin
    from mozart.learning.store_staging.escalation import EscalationMixin
    from mozart.learning.store_staging.budget import BudgetMixin

    class GlobalLearningStore(
        PatternMixin,
        ExecutionMixin,
        RateLimitMixin,
        DriftMixin,
        EscalationMixin,
        BudgetMixin,
        GlobalLearningStoreBase,
    ):
        """Global learning store combining all mixins."""
        pass

    __all__ = ["GlobalLearningStore", ...]
    ```

    **IMPORTANT:** Create in `store_staging/`, NOT `store/`. The atomic swap happens in Sheet 9.

    Write progress to {{ workspace }}/sheet8-init.md

    {% elif sheet_num == 9 %}
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  SHEET 9: ATOMIC SWAP + UPDATE IMPORTS + VERIFY                              ║
    ╚══════════════════════════════════════════════════════════════════════════════╝

    {% if previous_outputs %}
    Previous: {{ previous_outputs[8][:500] if 8 in previous_outputs else "" }}
    {% endif %}

    **Task:** Perform atomic swap and verify

    **CRITICAL: This sheet performs the atomic swap from staging to final.**

    Execute these commands IN ORDER:
    ```bash
    # 1. Atomic swap: staging → final
    mv src/mozart/learning/store_staging src/mozart/learning/store

    # 2. Rename original file to legacy
    mv src/mozart/learning/global_store.py src/mozart/learning/global_store_legacy.py
    ```

    Then create new `src/mozart/learning/global_store.py` that re-exports:
    ```python
    """Global learning store - re-exports from modular package."""
    from mozart.learning.store import *  # noqa
    from mozart.learning.store import GlobalLearningStore
    ```

    **After the swap, update __init__.py imports** from `store_staging` to `store`:
    - Change `from mozart.learning.store_staging.X` → `from mozart.learning.store.X`

    Verify imports work:
    ```bash
    python -c "from mozart.learning.global_store import GlobalLearningStore; print('OK')"
    python -c "from mozart.learning.store import GlobalLearningStore; print('OK')"
    ```

    Write final status to {{ workspace }}/sheet9-final.md

    {% endif %}

  variables:
    preamble: |
      ╔══════════════════════════════════════════════════════════════════════════╗
      ║            MOZART MODULARIZATION D2: global_store.py → store/            ║
      ║                                                                          ║
      ║  Target: Split 5136 LOC file into mixins                                 ║
      ║  Pattern: Mixin composition for 82-method class                          ║
      ╚══════════════════════════════════════════════════════════════════════════╝

      **Module Structure:**
      ```
      src/mozart/learning/store_staging/
      ├── __init__.py      # Composed GlobalLearningStore
      ├── models.py        # Dataclasses (~475 LOC)
      ├── base.py          # Core connection, schema (~400 LOC)
      ├── patterns.py      # PatternMixin (~1200 LOC)
      ├── executions.py    # ExecutionMixin (~600 LOC)
      ├── rate_limits.py   # RateLimitMixin (~250 LOC)
      ├── drift.py         # DriftMixin (~600 LOC)
      ├── escalation.py    # EscalationMixin (~300 LOC)
      └── budget.py        # BudgetMixin (~800 LOC)
      ```

      **Mixin Rules:**
      1. Each mixin inherits from object (no direct base class)
      2. Mixins access shared state via self._conn, self._logger
      3. Base class is listed LAST in MRO for proper initialization
      4. Keep ALL original code and docstrings

validations:
  # Sheet 2: models.py created
  - type: file_exists
    path: "src/mozart/learning/store_staging/models.py"
    description: "models.py module must exist"
    condition: "sheet_num >= 2 and sheet_num < 9"

  # Sheet 3: base.py created
  - type: file_exists
    path: "src/mozart/learning/store_staging/base.py"
    description: "base.py module must exist"
    condition: "sheet_num >= 3 and sheet_num < 9"

  # Sheet 4: patterns.py created
  - type: file_exists
    path: "src/mozart/learning/store_staging/patterns.py"
    description: "patterns.py module must exist"
    condition: "sheet_num >= 4 and sheet_num < 9"

  # Sheet 5: executions.py created
  - type: file_exists
    path: "src/mozart/learning/store_staging/executions.py"
    description: "executions.py module must exist"
    condition: "sheet_num >= 5 and sheet_num < 9"

  # Sheet 6: rate_limits.py + drift.py created
  - type: file_exists
    path: "src/mozart/learning/store_staging/rate_limits.py"
    description: "rate_limits.py module must exist"
    condition: "sheet_num >= 6 and sheet_num < 9"

  - type: file_exists
    path: "src/mozart/learning/store_staging/drift.py"
    description: "drift.py module must exist"
    condition: "sheet_num >= 6 and sheet_num < 9"

  # Sheet 7: escalation.py + budget.py created
  - type: file_exists
    path: "src/mozart/learning/store_staging/escalation.py"
    description: "escalation.py module must exist"
    condition: "sheet_num >= 7 and sheet_num < 9"

  - type: file_exists
    path: "src/mozart/learning/store_staging/budget.py"
    description: "budget.py module must exist"
    condition: "sheet_num >= 7 and sheet_num < 9"

  # Sheet 8: __init__.py created in staging
  - type: file_exists
    path: "src/mozart/learning/store_staging/__init__.py"
    description: "Package __init__.py must exist in staging"
    condition: "sheet_num == 8"

  # Sheet 9: After atomic swap, check final location
  - type: file_exists
    path: "src/mozart/learning/store/__init__.py"
    description: "Package __init__.py must exist after swap"
    condition: "sheet_num == 9"

  # Sheet 9: imports work + tests pass
  - type: command_succeeds
    command: "python -c 'from mozart.learning.global_store import GlobalLearningStore; print(\"OK\")'"
    description: "GlobalLearningStore import must work"
    condition: "sheet_num == 9"

  - type: command_succeeds
    command: "pytest tests/test_global_learning.py -x -q --tb=no 2>&1 | tail -1 | grep -E '(passed|OK)'"
    description: "Global learning tests must pass"
    condition: "sheet_num == 9"

# Chain to D3 on success
on_success:
  - type: run_job
    job_path: "modularization-d3.yaml"
    description: "Chain to D3: runner.py modularization"
    detached: true  # Run independently to avoid 300s hook timeout

concert:
  enabled: true
  max_chain_depth: 10
  cooldown_between_jobs_seconds: 30
  inherit_workspace: false
